<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Test | Audit Analytics with R</title>
  <meta name="description" content="A toolkit for Internal Audit and Financial auditors" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Test | Audit Analytics with R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://auditanalytics.jonlin.ca/" />
  
  <meta property="og:description" content="A toolkit for Internal Audit and Financial auditors" />
  <meta name="github-repo" content="jonlinca/auditanalytics" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Test | Audit Analytics with R" />
  
  <meta name="twitter:description" content="A toolkit for Internal Audit and Financial auditors" />
  

<meta name="author" content="Jonathan Lin" />


<meta name="date" content="2020-11-22" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="exploring-data.html"/>
<link rel="next" href="report.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<script src="libs/viz-1.8.2/viz.js"></script>
<link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script>
<script src="libs/d3-3.3.8/d3.min.js"></script>
<script src="libs/dagre-0.4.0/dagre-d3.min.js"></script>
<link href="libs/mermaid-0.3.0/dist/mermaid.css" rel="stylesheet" />
<script src="libs/mermaid-0.3.0/dist/mermaid.slim.min.js"></script>
<script src="libs/chromatography-0.1/chromatography.js"></script>
<script src="libs/DiagrammeR-binding-1.0.6.1/DiagrammeR.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.14/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Audit Analytics in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="" data-path="about-the-author.html"><a href="about-the-author.html"><i class="fa fa-check"></i>About the author</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="part"><span><b>I Structure</b></span></li>
<li class="chapter" data-level="2" data-path="approach.html"><a href="approach.html"><i class="fa fa-check"></i><b>2</b> Approach</a><ul>
<li class="chapter" data-level="2.1" data-path="approach.html"><a href="approach.html#code-based-development"><i class="fa fa-check"></i><b>2.1</b> Code-based development</a></li>
<li class="chapter" data-level="2.2" data-path="approach.html"><a href="approach.html#automate-relentlessly"><i class="fa fa-check"></i><b>2.2</b> Automate relentlessly</a></li>
<li class="chapter" data-level="2.3" data-path="approach.html"><a href="approach.html#share-everything"><i class="fa fa-check"></i><b>2.3</b> Share everything</a></li>
<li class="chapter" data-level="2.4" data-path="approach.html"><a href="approach.html#always-deliver-useful-product"><i class="fa fa-check"></i><b>2.4</b> Always deliver useful product</a></li>
<li class="chapter" data-level="2.5" data-path="approach.html"><a href="approach.html#dont-be-a-hero"><i class="fa fa-check"></i><b>2.5</b> Don’t be a hero</a></li>
<li class="chapter" data-level="2.6" data-path="approach.html"><a href="approach.html#the-opportunity-cost"><i class="fa fa-check"></i><b>2.6</b> “The opportunity cost”</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="architecture.html"><a href="architecture.html"><i class="fa fa-check"></i><b>3</b> Architecture</a><ul>
<li class="chapter" data-level="3.1" data-path="architecture.html"><a href="architecture.html#architecture-r"><i class="fa fa-check"></i><b>3.1</b> R and RStudio</a></li>
<li class="chapter" data-level="3.2" data-path="architecture.html"><a href="architecture.html#code-repositories"><i class="fa fa-check"></i><b>3.2</b> Code repositories</a><ul>
<li class="chapter" data-level="3.2.1" data-path="architecture.html"><a href="architecture.html#git"><i class="fa fa-check"></i><b>3.2.1</b> git</a></li>
<li class="chapter" data-level="3.2.2" data-path="architecture.html"><a href="architecture.html#packages"><i class="fa fa-check"></i><b>3.2.2</b> Packages</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="architecture.html"><a href="architecture.html#data-products"><i class="fa fa-check"></i><b>3.3</b> Data products</a><ul>
<li class="chapter" data-level="3.3.1" data-path="architecture.html"><a href="architecture.html#galvanize-highbond"><i class="fa fa-check"></i><b>3.3.1</b> Galvanize Highbond</a></li>
<li class="chapter" data-level="3.3.2" data-path="architecture.html"><a href="architecture.html#architecture-rsc"><i class="fa fa-check"></i><b>3.3.2</b> RStudio Connect</a></li>
<li class="chapter" data-level="3.3.3" data-path="architecture.html"><a href="architecture.html#rstudio-package-manager"><i class="fa fa-check"></i><b>3.3.3</b> RStudio Package Manager</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="architecture.html"><a href="architecture.html#data-sources"><i class="fa fa-check"></i><b>3.4</b> Data sources</a><ul>
<li class="chapter" data-level="3.4.1" data-path="architecture.html"><a href="architecture.html#internal-databases"><i class="fa fa-check"></i><b>3.4.1</b> Internal databases</a></li>
<li class="chapter" data-level="3.4.2" data-path="architecture.html"><a href="architecture.html#external-sources"><i class="fa fa-check"></i><b>3.4.2</b> External sources</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="architecture.html"><a href="architecture.html#audit-data-mart"><i class="fa fa-check"></i><b>3.5</b> Audit data mart</a></li>
</ul></li>
<li class="part"><span><b>II Technical</b></span></li>
<li class="chapter" data-level="4" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>4</b> Setup</a><ul>
<li class="chapter" data-level="4.1" data-path="setup.html"><a href="setup.html#setup-r"><i class="fa fa-check"></i><b>4.1</b> R with RStudio</a></li>
<li class="chapter" data-level="4.2" data-path="setup.html"><a href="setup.html#common-packages"><i class="fa fa-check"></i><b>4.2</b> Common packages</a></li>
<li class="chapter" data-level="4.3" data-path="setup.html"><a href="setup.html#highbond-r-package"><i class="fa fa-check"></i><b>4.3</b> Highbond R package</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="import-data.html"><a href="import-data.html"><i class="fa fa-check"></i><b>5</b> Import data</a><ul>
<li class="chapter" data-level="5.1" data-path="import-data.html"><a href="import-data.html#delimited-files"><i class="fa fa-check"></i><b>5.1</b> Delimited files</a><ul>
<li class="chapter" data-level="5.1.1" data-path="import-data.html"><a href="import-data.html#handling-problematic-delimited-files"><i class="fa fa-check"></i><b>5.1.1</b> Handling problematic delimited files</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="import-data.html"><a href="import-data.html#import-db"><i class="fa fa-check"></i><b>5.2</b> Databases</a></li>
<li class="chapter" data-level="5.3" data-path="import-data.html"><a href="import-data.html#apis"><i class="fa fa-check"></i><b>5.3</b> APIs</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-completeness.html"><a href="data-completeness.html"><i class="fa fa-check"></i><b>6</b> Data Completeness</a><ul>
<li class="chapter" data-level="6.1" data-path="data-completeness.html"><a href="data-completeness.html#exploration-of-general-ledger-data"><i class="fa fa-check"></i><b>6.1</b> Exploration of General Ledger data</a></li>
<li class="chapter" data-level="6.2" data-path="data-completeness.html"><a href="data-completeness.html#examination-of-potential-errors"><i class="fa fa-check"></i><b>6.2</b> Examination of potential errors</a><ul>
<li class="chapter" data-level="6.2.1" data-path="data-completeness.html"><a href="data-completeness.html#completeness-na"><i class="fa fa-check"></i><b>6.2.1</b> NA values</a></li>
<li class="chapter" data-level="6.2.2" data-path="data-completeness.html"><a href="data-completeness.html#journal-entries-balance-to-zero"><i class="fa fa-check"></i><b>6.2.2</b> Journal Entries balance to zero</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="data-completeness.html"><a href="data-completeness.html#transforming-of-trial-balance-data"><i class="fa fa-check"></i><b>6.3</b> Transforming of Trial Balance data</a><ul>
<li class="chapter" data-level="6.3.1" data-path="data-completeness.html"><a href="data-completeness.html#sum-by-absolute-references"><i class="fa fa-check"></i><b>6.3.1</b> Sum by absolute references</a></li>
<li class="chapter" data-level="6.3.2" data-path="data-completeness.html"><a href="data-completeness.html#sum-by-numeric-position"><i class="fa fa-check"></i><b>6.3.2</b> Sum by numeric position</a></li>
<li class="chapter" data-level="6.3.3" data-path="data-completeness.html"><a href="data-completeness.html#sum-by-named-references"><i class="fa fa-check"></i><b>6.3.3</b> Sum by named references</a></li>
<li class="chapter" data-level="6.3.4" data-path="data-completeness.html"><a href="data-completeness.html#pivot-then-summarize"><i class="fa fa-check"></i><b>6.3.4</b> Pivot then summarize</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="data-completeness.html"><a href="data-completeness.html#asserting-completeness"><i class="fa fa-check"></i><b>6.4</b> Asserting Completeness</a><ul>
<li class="chapter" data-level="6.4.1" data-path="data-completeness.html"><a href="data-completeness.html#completeness-join"><i class="fa fa-check"></i><b>6.4.1</b> Joining the GL to the TB</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="data-completeness.html"><a href="data-completeness.html#cautionary-notes-for-completeness"><i class="fa fa-check"></i><b>6.5</b> Cautionary notes for Completeness</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="cleaning-data.html"><a href="cleaning-data.html"><i class="fa fa-check"></i><b>7</b> Cleaning data</a><ul>
<li class="chapter" data-level="7.1" data-path="cleaning-data.html"><a href="cleaning-data.html#basic-math"><i class="fa fa-check"></i><b>7.1</b> Basic math</a></li>
<li class="chapter" data-level="7.2" data-path="cleaning-data.html"><a href="cleaning-data.html#dates-and-times"><i class="fa fa-check"></i><b>7.2</b> Dates and Times</a><ul>
<li class="chapter" data-level="7.2.1" data-path="cleaning-data.html"><a href="cleaning-data.html#understanding-default-time-zones"><i class="fa fa-check"></i><b>7.2.1</b> Understanding Default Time Zones</a></li>
<li class="chapter" data-level="7.2.2" data-path="cleaning-data.html"><a href="cleaning-data.html#override-or-display-timezones"><i class="fa fa-check"></i><b>7.2.2</b> Override or display timezones</a></li>
<li class="chapter" data-level="7.2.3" data-path="cleaning-data.html"><a href="cleaning-data.html#daylight-saving-implications"><i class="fa fa-check"></i><b>7.2.3</b> Daylight Saving Implications</a></li>
<li class="chapter" data-level="7.2.4" data-path="cleaning-data.html"><a href="cleaning-data.html#differences-between-time"><i class="fa fa-check"></i><b>7.2.4</b> Differences between time</a></li>
<li class="chapter" data-level="7.2.5" data-path="cleaning-data.html"><a href="cleaning-data.html#derived-date-information"><i class="fa fa-check"></i><b>7.2.5</b> Derived date information</a></li>
<li class="chapter" data-level="7.2.6" data-path="cleaning-data.html"><a href="cleaning-data.html#cleaning-numerical-dates"><i class="fa fa-check"></i><b>7.2.6</b> Cleaning numerical dates</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="cleaning-data.html"><a href="cleaning-data.html#separate"><i class="fa fa-check"></i><b>7.3</b> Separate</a></li>
<li class="chapter" data-level="7.4" data-path="cleaning-data.html"><a href="cleaning-data.html#separate_rows"><i class="fa fa-check"></i><b>7.4</b> Separate_rows</a></li>
<li class="chapter" data-level="7.5" data-path="cleaning-data.html"><a href="cleaning-data.html#tidy-data"><i class="fa fa-check"></i><b>7.5</b> Tidy data</a></li>
<li class="chapter" data-level="7.6" data-path="cleaning-data.html"><a href="cleaning-data.html#clean-pivot"><i class="fa fa-check"></i><b>7.6</b> Pivots, wide and longer</a></li>
<li class="chapter" data-level="7.7" data-path="cleaning-data.html"><a href="cleaning-data.html#joining-data"><i class="fa fa-check"></i><b>7.7</b> Joining data</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="exploring-data.html"><a href="exploring-data.html"><i class="fa fa-check"></i><b>8</b> Exploring data</a><ul>
<li class="chapter" data-level="8.1" data-path="exploring-data.html"><a href="exploring-data.html#explore-stats"><i class="fa fa-check"></i><b>8.1</b> Basic Statistics</a></li>
<li class="chapter" data-level="8.2" data-path="exploring-data.html"><a href="exploring-data.html#summarizations"><i class="fa fa-check"></i><b>8.2</b> Summarizations</a></li>
<li class="chapter" data-level="8.3" data-path="exploring-data.html"><a href="exploring-data.html#data-visualization---why"><i class="fa fa-check"></i><b>8.3</b> Data Visualization - Why</a></li>
<li class="chapter" data-level="8.4" data-path="exploring-data.html"><a href="exploring-data.html#data-visualization---how"><i class="fa fa-check"></i><b>8.4</b> Data Visualization - How</a><ul>
<li class="chapter" data-level="8.4.1" data-path="exploring-data.html"><a href="exploring-data.html#time-series"><i class="fa fa-check"></i><b>8.4.1</b> Time-series</a></li>
<li class="chapter" data-level="8.4.2" data-path="exploring-data.html"><a href="exploring-data.html#facets"><i class="fa fa-check"></i><b>8.4.2</b> Facets</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="test.html"><a href="test.html"><i class="fa fa-check"></i><b>9</b> Test</a><ul>
<li class="chapter" data-level="9.1" data-path="test.html"><a href="test.html#amount-based-tests"><i class="fa fa-check"></i><b>9.1</b> Amount-based tests</a><ul>
<li class="chapter" data-level="9.1.1" data-path="test.html"><a href="test.html#above-te"><i class="fa fa-check"></i><b>9.1.1</b> Above threshold</a></li>
<li class="chapter" data-level="9.1.2" data-path="test.html"><a href="test.html#round-numbers"><i class="fa fa-check"></i><b>9.1.2</b> Round numbers</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="test.html"><a href="test.html#date-based-tests"><i class="fa fa-check"></i><b>9.2</b> Date-based tests</a><ul>
<li class="chapter" data-level="9.2.1" data-path="test.html"><a href="test.html#weekend-testing"><i class="fa fa-check"></i><b>9.2.1</b> Weekend testing</a></li>
<li class="chapter" data-level="9.2.2" data-path="test.html"><a href="test.html#cutoff-testing"><i class="fa fa-check"></i><b>9.2.2</b> Cutoff testing</a></li>
<li class="chapter" data-level="9.2.3" data-path="test.html"><a href="test.html#age"><i class="fa fa-check"></i><b>9.2.3</b> Age</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="test.html"><a href="test.html#basic-statistical-tests"><i class="fa fa-check"></i><b>9.3</b> Basic Statistical tests</a><ul>
<li class="chapter" data-level="9.3.1" data-path="test.html"><a href="test.html#outliers-based-on-amount"><i class="fa fa-check"></i><b>9.3.1</b> Outliers based on amount</a></li>
<li class="chapter" data-level="9.3.2" data-path="test.html"><a href="test.html#outliers-based-on-amounts-and-other-factors"><i class="fa fa-check"></i><b>9.3.2</b> Outliers based on amounts and other factors</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="test.html"><a href="test.html#unusual-pattern-and-behaviours"><i class="fa fa-check"></i><b>9.4</b> Unusual pattern and behaviours</a><ul>
<li class="chapter" data-level="9.4.1" data-path="test.html"><a href="test.html#benfords-law-analysis"><i class="fa fa-check"></i><b>9.4.1</b> Benford’s Law analysis</a></li>
<li class="chapter" data-level="9.4.2" data-path="test.html"><a href="test.html#relative-size-factor-rsf"><i class="fa fa-check"></i><b>9.4.2</b> Relative size factor (RSF)</a></li>
<li class="chapter" data-level="9.4.3" data-path="test.html"><a href="test.html#duplicate-invoices"><i class="fa fa-check"></i><b>9.4.3</b> Duplicate Invoices</a></li>
<li class="chapter" data-level="9.4.4" data-path="test.html"><a href="test.html#detecting-gaps-in-sequences"><i class="fa fa-check"></i><b>9.4.4</b> Detecting gaps in sequences</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="test.html"><a href="test.html#test-searchtext"><i class="fa fa-check"></i><b>9.5</b> Search text</a><ul>
<li class="chapter" data-level="9.5.1" data-path="test.html"><a href="test.html#regex-basics"><i class="fa fa-check"></i><b>9.5.1</b> Regex basics</a></li>
<li class="chapter" data-level="9.5.2" data-path="test.html"><a href="test.html#starts-or-ends-with-anchors"><i class="fa fa-check"></i><b>9.5.2</b> Starts or Ends with (Anchors)</a></li>
<li class="chapter" data-level="9.5.3" data-path="test.html"><a href="test.html#crash-course-in-encoding"><i class="fa fa-check"></i><b>9.5.3</b> Crash course in Encoding</a></li>
<li class="chapter" data-level="9.5.4" data-path="test.html"><a href="test.html#cleaning-text"><i class="fa fa-check"></i><b>9.5.4</b> Cleaning Text</a></li>
<li class="chapter" data-level="9.5.5" data-path="test.html"><a href="test.html#searching-multiple-fields"><i class="fa fa-check"></i><b>9.5.5</b> Searching Multiple Fields</a></li>
<li class="chapter" data-level="9.5.6" data-path="test.html"><a href="test.html#regex-further"><i class="fa fa-check"></i><b>9.5.6</b> Further reading</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="report.html"><a href="report.html"><i class="fa fa-check"></i><b>10</b> Report</a><ul>
<li class="chapter" data-level="10.1" data-path="report.html"><a href="report.html#report-structure"><i class="fa fa-check"></i><b>10.1</b> Report Structure</a></li>
<li class="chapter" data-level="10.2" data-path="report.html"><a href="report.html#export-files"><i class="fa fa-check"></i><b>10.2</b> Export files</a></li>
</ul></li>
<li class="part"><span><b>III Advanced teams</b></span></li>
<li class="chapter" data-level="11" data-path="applied-audit-analytics.html"><a href="applied-audit-analytics.html"><i class="fa fa-check"></i><b>11</b> Applied Audit Analytics</a></li>
<li class="chapter" data-level="12" data-path="auditpackage.html"><a href="auditpackage.html"><i class="fa fa-check"></i><b>12</b> Audit R Package</a><ul>
<li class="chapter" data-level="12.1" data-path="auditpackage.html"><a href="auditpackage.html#package-functions"><i class="fa fa-check"></i><b>12.1</b> Package functions</a></li>
<li class="chapter" data-level="12.2" data-path="auditpackage.html"><a href="auditpackage.html#templates"><i class="fa fa-check"></i><b>12.2</b> Templates</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="continuous-monitoring.html"><a href="continuous-monitoring.html"><i class="fa fa-check"></i><b>13</b> Continuous monitoring</a><ul>
<li class="chapter" data-level="13.1" data-path="continuous-monitoring.html"><a href="continuous-monitoring.html#considerations"><i class="fa fa-check"></i><b>13.1</b> Considerations</a></li>
<li class="chapter" data-level="13.2" data-path="continuous-monitoring.html"><a href="continuous-monitoring.html#create-a-collection-analytic-and-table"><i class="fa fa-check"></i><b>13.2</b> Create a Collection, Analytic and Table</a></li>
<li class="chapter" data-level="13.3" data-path="continuous-monitoring.html"><a href="continuous-monitoring.html#define-the-high-risk-test"><i class="fa fa-check"></i><b>13.3</b> Define the High Risk test</a></li>
<li class="chapter" data-level="13.4" data-path="continuous-monitoring.html"><a href="continuous-monitoring.html#uploading-additional-results"><i class="fa fa-check"></i><b>13.4</b> Uploading additional results</a></li>
<li class="chapter" data-level="13.5" data-path="continuous-monitoring.html"><a href="continuous-monitoring.html#downloading-records-and-responses"><i class="fa fa-check"></i><b>13.5</b> Downloading records and responses</a></li>
<li class="chapter" data-level="13.6" data-path="continuous-monitoring.html"><a href="continuous-monitoring.html#triggers-and-questionnaires"><i class="fa fa-check"></i><b>13.6</b> Triggers and Questionnaires</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="applied-datamart.html"><a href="applied-datamart.html"><i class="fa fa-check"></i><b>14</b> Audit Data Mart</a><ul>
<li class="chapter" data-level="14.1" data-path="applied-datamart.html"><a href="applied-datamart.html#what-to-etl"><i class="fa fa-check"></i><b>14.1</b> What to ETL</a></li>
<li class="chapter" data-level="14.2" data-path="applied-datamart.html"><a href="applied-datamart.html#etl-essentials"><i class="fa fa-check"></i><b>14.2</b> ETL Essentials</a></li>
<li class="chapter" data-level="14.3" data-path="applied-datamart.html"><a href="applied-datamart.html#etl-example"><i class="fa fa-check"></i><b>14.3</b> ETL Example</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="machine-learning.html"><a href="machine-learning.html"><i class="fa fa-check"></i><b>15</b> Machine Learning</a><ul>
<li class="chapter" data-level="15.1" data-path="machine-learning.html"><a href="machine-learning.html#predict-an-account-class"><i class="fa fa-check"></i><b>15.1</b> Predict an account class</a></li>
<li class="chapter" data-level="15.2" data-path="machine-learning.html"><a href="machine-learning.html#generating-features"><i class="fa fa-check"></i><b>15.2</b> Generating features</a></li>
<li class="chapter" data-level="15.3" data-path="machine-learning.html"><a href="machine-learning.html#training-the-model"><i class="fa fa-check"></i><b>15.3</b> Training the model</a></li>
<li class="chapter" data-level="15.4" data-path="machine-learning.html"><a href="machine-learning.html#making-predictions"><i class="fa fa-check"></i><b>15.4</b> Making predictions</a></li>
<li class="chapter" data-level="15.5" data-path="machine-learning.html"><a href="machine-learning.html#what-to-explore-next"><i class="fa fa-check"></i><b>15.5</b> What to explore next</a></li>
</ul></li>
<li class="part"><span><b>IV Appendix</b></span></li>
<li class="chapter" data-level="16" data-path="appendix-ca.html"><a href="appendix-ca.html"><i class="fa fa-check"></i><b>16</b> Continuous Auditing methodology</a><ul>
<li class="chapter" data-level="16.1" data-path="appendix-ca.html"><a href="appendix-ca.html#support-for-continuous-auditing"><i class="fa fa-check"></i><b>16.1</b> Support for Continuous Auditing</a></li>
<li class="chapter" data-level="16.2" data-path="appendix-ca.html"><a href="appendix-ca.html#the-requirements-for-evaluting-icfr"><i class="fa fa-check"></i><b>16.2</b> The requirements for evaluting ICFR</a></li>
<li class="chapter" data-level="16.3" data-path="appendix-ca.html"><a href="appendix-ca.html#determining-population-tolerable-error-rate"><i class="fa fa-check"></i><b>16.3</b> Determining population tolerable error rate</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="other-practices-to-follow.html"><a href="other-practices-to-follow.html"><i class="fa fa-check"></i><b>17</b> Other practices to follow</a><ul>
<li class="chapter" data-level="17.1" data-path="other-practices-to-follow.html"><a href="other-practices-to-follow.html#documentation"><i class="fa fa-check"></i><b>17.1</b> Documentation</a></li>
<li class="chapter" data-level="17.2" data-path="other-practices-to-follow.html"><a href="other-practices-to-follow.html#passwords"><i class="fa fa-check"></i><b>17.2</b> Passwords</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Audit Analytics with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="test" class="section level1">
<h1><span class="header-section-number">Chapter 9</span> Test</h1>
<p>Testing data is the act of isolating high-risk records that meet criteria. While generally the intent of data analytics within auditing is to gain 100% population coverage and associated assurance, what will inevitably happen is that process deviations are revealed as items are detected. No process is bullet-proof and exception free, and therefore the auditor should have a founded idea of their level of risk tolerance prior to testing. Testing data will then help auditors articulate the nature of the exceptions and the overall risk level.</p>
<p>Auditors must recognize that not all tests (and lines that meet these tests) immediately ascertain that the control has failed or that something suspicious has occurred. Rather, it points to items that require further inspection and judgment. By iterating your workflow, you will be able to reduce the incidence of false positives and increase your detection rate, allowing you to focus on follow-up of higher-risk activity.</p>
<p>For this section we will use the company GL database.</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="test.html#cb265-1"></a><span class="kw">library</span>(dplyr) </span>
<span id="cb265-2"><a href="test.html#cb265-2"></a><span class="kw">library</span>(tidyr) </span>
<span id="cb265-3"><a href="test.html#cb265-3"></a><span class="kw">library</span>(lubridate) </span>
<span id="cb265-4"><a href="test.html#cb265-4"></a><span class="kw">library</span>(DBI) </span>
<span id="cb265-5"><a href="test.html#cb265-5"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb265-6"><a href="test.html#cb265-6"></a><span class="kw">library</span>(gt) <span class="co"># Used for formatting outputs</span></span>
<span id="cb265-7"><a href="test.html#cb265-7"></a><span class="kw">library</span>(pryr) <span class="co"># Used to analyze encoding in text chapter</span></span>
<span id="cb265-8"><a href="test.html#cb265-8"></a><span class="kw">library</span>(stringi) <span class="co"># specialized string processing</span></span>
<span id="cb265-9"><a href="test.html#cb265-9"></a></span>
<span id="cb265-10"><a href="test.html#cb265-10"></a><span class="kw">dir.create</span>(<span class="st">&quot;data&quot;</span>, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)</span>
<span id="cb265-11"><a href="test.html#cb265-11"></a></span>
<span id="cb265-12"><a href="test.html#cb265-12"></a><span class="kw">download.file</span>(<span class="dt">url =</span> <span class="st">&quot;https://github.com/jonlinca/auditanalytics/raw/master/data/rauditanalytics.sqlite&quot;</span>,</span>
<span id="cb265-13"><a href="test.html#cb265-13"></a>             <span class="dt">destfile =</span> <span class="st">&quot;data/rauditanalytics.sqlite&quot;</span>, <span class="dt">mode =</span> <span class="st">&quot;wb&quot;</span>)</span>
<span id="cb265-14"><a href="test.html#cb265-14"></a></span>
<span id="cb265-15"><a href="test.html#cb265-15"></a>con &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(RSQLite<span class="op">::</span><span class="kw">SQLite</span>(), <span class="st">&quot;data/rauditanalytics.sqlite&quot;</span>)</span>
<span id="cb265-16"><a href="test.html#cb265-16"></a></span>
<span id="cb265-17"><a href="test.html#cb265-17"></a>gl &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&#39;gl&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb265-18"><a href="test.html#cb265-18"></a><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></span>
<span id="cb265-19"><a href="test.html#cb265-19"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gl_date =</span> <span class="kw">as_date</span>(gl_date, <span class="dt">origin =</span> <span class="st">&#39;1970-01-01&#39;</span>),</span>
<span id="cb265-20"><a href="test.html#cb265-20"></a>         <span class="dt">paid_date =</span> <span class="kw">as_date</span>(paid_date, <span class="dt">origin =</span> <span class="st">&#39;1970-01-01&#39;</span>),</span>
<span id="cb265-21"><a href="test.html#cb265-21"></a>         <span class="dt">invoice_date =</span> <span class="kw">as_date</span>(invoice_date, <span class="dt">origin =</span> <span class="st">&#39;1970-01-01&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb265-22"><a href="test.html#cb265-22"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>gl_date_char)</span>
<span id="cb265-23"><a href="test.html#cb265-23"></a></span>
<span id="cb265-24"><a href="test.html#cb265-24"></a><span class="kw">dbDisconnect</span>(con)</span></code></pre></div>
<p>Our primary commands for this chapter will be <code>mutate()</code> and <code>filter()</code>. The <code>mutate()</code> command is useful for testing data, as it allows the auditor to add features and/or criteria to their testing. After records have been identified, <code>filter()</code> will extract the rows matching criteria.</p>
<p>While you may able to directly <code>filter()</code> rows based on criteria, you may find it more effective to instead create the new fields with <code>mutate()</code> that match the filter criteria. My style for documenting tests is to create any additional features needed, and then create a corresponding test column, with <code>t_</code> as the prefix, and isolate for these invoices to perform inspection and follow-up. This has benefits in the long run, including:</p>
<ul>
<li>Keeping all the tests on the same record allows for an easier way to detect any row that met multiple criteria,</li>
<li>It is straightforward to extract the rows that meets a test, and</li>
<li>Each new column related to a specific a criteria is akin to feature engineering, enabling the reuse of the tests for machine learning applications.</li>
</ul>
<p>There are practical reasons why you may need to create separate data frame objects, so do not prescribe exclusively to this method for extremely long or sophisticated steps. In cases when you have to perform multiple steps to get to your answer, it is advisable to bring the final result back into an overall reference table.</p>
<div id="amount-based-tests" class="section level2">
<h2><span class="header-section-number">9.1</span> Amount-based tests</h2>
<div id="above-te" class="section level3">
<h3><span class="header-section-number">9.1.1</span> Above threshold</h3>
<p>The most classical test is to test items that meet or exceed a material value.</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="test.html#cb266-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb266-2"><a href="test.html#cb266-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_over_te =</span> amount <span class="op">&gt;=</span><span class="st"> </span><span class="dv">60000</span>) <span class="op">%&gt;%</span></span>
<span id="cb266-3"><a href="test.html#cb266-3"></a><span class="st">  </span><span class="kw">filter</span>(t_over_te) <span class="op">%&gt;%</span></span>
<span id="cb266-4"><a href="test.html#cb266-4"></a><span class="st">  </span><span class="kw">select</span>(je_num, amount, <span class="kw">everything</span>())</span></code></pre></div>
<pre><code>## # A tibble: 2 x 9
##   je_num amount gl_date    vendor_id account invoice_date description paid_date 
##    &lt;int&gt;  &lt;dbl&gt; &lt;date&gt;         &lt;int&gt; &lt;chr&gt;   &lt;date&gt;       &lt;chr&gt;       &lt;date&gt;    
## 1    140 96355. 2019-12-19      2211 exp_ma… 2019-12-12   Packaging … 2020-01-18
## 2    693 88524. 2019-08-13      2726 exp_ma… 2019-08-06   Quality co… 2019-08-16
## # … with 1 more variable: t_over_te &lt;lgl&gt;</code></pre>
<p>When performing amount or threshold testing, you may be more interested in the actual magnitude, and not necessarily the direction. This is especially true within accounting matters, where the implication of negative and positive amounts change depending on the transaction - i.e., a debit or a credit transaction, or affecting a balance sheet or income statement account can tell a very different story.</p>
<p>In these cases, you may want to consider using absolute values as the comparison. This allows you to capture the magnitude of the change:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="test.html#cb268-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb268-2"><a href="test.html#cb268-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_over_te =</span> <span class="kw">abs</span>(amount) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">60000</span>) <span class="op">%&gt;%</span></span>
<span id="cb268-3"><a href="test.html#cb268-3"></a><span class="st">  </span><span class="kw">filter</span>(t_over_te)</span></code></pre></div>
<pre><code>## # A tibble: 4 x 9
##   je_num  amount gl_date    vendor_id account invoice_date description
##    &lt;int&gt;   &lt;dbl&gt; &lt;date&gt;         &lt;int&gt; &lt;chr&gt;   &lt;date&gt;       &lt;chr&gt;      
## 1    140  96355. 2019-12-19      2211 exp_ma… 2019-12-12   Packaging …
## 2    140 -96355. 2019-12-19        NA liab_a… 2019-12-12   Packaging …
## 3    693  88524. 2019-08-13      2726 exp_ma… 2019-08-06   Quality co…
## 4    693 -88524. 2019-08-13        NA liab_a… 2019-08-06   Quality co…
## # … with 2 more variables: paid_date &lt;date&gt;, t_over_te &lt;lgl&gt;</code></pre>
</div>
<div id="round-numbers" class="section level3">
<h3><span class="header-section-number">9.1.2</span> Round numbers</h3>
<p>In forensic accounting, auditors tend to take the position that transactions rarely end in whole dollars, especially if they end in multiples of 5, or even in multiples of tens.</p>
<p>Detection of these is contingent on the use of <code>%%</code>, better known as the modulo operator. It will calculate the remainder of a division calculation; dividing 1.50 by 1 will give you a remainder of 0.5.</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="test.html#cb270-1"></a><span class="fl">1.50</span> <span class="op">%%</span><span class="st"> </span><span class="dv">1</span></span></code></pre></div>
<pre><code>## [1] 0.5</code></pre>
<p>This same approach can be used to detect if a transaction is round, i.e. has no ‘cents’ in it. How you decide to apply this can be useful in many cases. For example, finding a transaction that happens to be cleanly in the ‘thousands’, perform the modulo by the corresponding amount and look for results where the remainder is 0.</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="test.html#cb272-1"></a><span class="dv">15000</span> <span class="op">%%</span><span class="st"> </span><span class="dv">1000</span></span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>Or even a round five number, which has its use cases when it comes to things like gift cards or tipping at restaurants:</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="test.html#cb274-1"></a><span class="dv">25</span> <span class="op">%%</span><span class="st"> </span><span class="dv">5</span></span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>When implementing as a test, I’d encourage creating multiple tests to see which test it matched, and then detect these variations together:</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="test.html#cb276-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb276-2"><a href="test.html#cb276-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_round_5 =</span> amount <span class="op">%%</span><span class="st"> </span><span class="dv">5</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb276-3"><a href="test.html#cb276-3"></a>         <span class="dt">t_round_10 =</span> amount <span class="op">%%</span><span class="st"> </span><span class="dv">10</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb276-4"><a href="test.html#cb276-4"></a>         <span class="dt">t_round_100 =</span> amount <span class="op">%%</span><span class="st"> </span><span class="dv">100</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb276-5"><a href="test.html#cb276-5"></a>         <span class="dt">t_round_1000 =</span> amount <span class="op">%%</span><span class="st"> </span><span class="dv">1000</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb276-6"><a href="test.html#cb276-6"></a><span class="st">  </span><span class="kw">filter_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;t_round&quot;</span>)), <span class="kw">any_vars</span>(.)) <span class="op">%&gt;%</span></span>
<span id="cb276-7"><a href="test.html#cb276-7"></a><span class="st">  </span><span class="kw">select</span>(je_num, amount, <span class="kw">starts_with</span>(<span class="st">&quot;t_round&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   je_num amount t_round_5 t_round_10 t_round_100 t_round_1000
##    &lt;int&gt;  &lt;dbl&gt; &lt;lgl&gt;     &lt;lgl&gt;      &lt;lgl&gt;       &lt;lgl&gt;       
## 1    621  12800 TRUE      TRUE       TRUE        FALSE       
## 2    621 -12800 TRUE      TRUE       TRUE        FALSE</code></pre>
</div>
</div>
<div id="date-based-tests" class="section level2">
<h2><span class="header-section-number">9.2</span> Date-based tests</h2>
<div id="weekend-testing" class="section level3">
<h3><span class="header-section-number">9.2.1</span> Weekend testing</h3>
<p>As a typical office business (along with office activities) generally happen on the weekday - that is, Monday through Friday. We may be interested in selecting journal entries from a sample of activities that occurred on the weekend. To test this, we can use the <strong>lubridate</strong> package to determine what day of week our entry falls upon:</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="test.html#cb278-1"></a>gl &lt;-<span class="st"> </span>gl <span class="op">%&gt;%</span></span>
<span id="cb278-2"><a href="test.html#cb278-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">day_of_week =</span> <span class="kw">wday</span>(gl_date, <span class="dt">label =</span> <span class="ot">TRUE</span>),  <span class="co"># Label is useful if you tend to forget what each number means</span></span>
<span id="cb278-3"><a href="test.html#cb278-3"></a>         <span class="dt">t_weekend =</span> day_of_week <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Sat&#39;</span>, <span class="st">&#39;Sun&#39;</span>))</span>
<span id="cb278-4"><a href="test.html#cb278-4"></a></span>
<span id="cb278-5"><a href="test.html#cb278-5"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb278-6"><a href="test.html#cb278-6"></a><span class="st">  </span><span class="kw">filter</span>(t_weekend) <span class="op">%&gt;%</span></span>
<span id="cb278-7"><a href="test.html#cb278-7"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 x 10
##   je_num  amount gl_date    vendor_id account invoice_date description
##    &lt;int&gt;   &lt;dbl&gt; &lt;date&gt;         &lt;int&gt; &lt;chr&gt;   &lt;date&gt;       &lt;chr&gt;      
## 1     54  35758. 2019-01-12      2612 exp_ma… 2019-01-02   Face mask …
## 2     54 -35758. 2019-01-12        NA liab_a… 2019-01-02   Face mask …
## 3    102  50135. 2019-01-12      2726 exp_ma… 2019-01-05   Medical gr…
## 4    102 -50135. 2019-01-12        NA liab_a… 2019-01-05   Medical gr…
## 5    223  50128. 2019-01-12      2211 exp_ma… 2019-01-05   Packaging …
## 6    223 -50128. 2019-01-12        NA liab_a… 2019-01-05   Packaging …
## # … with 3 more variables: paid_date &lt;date&gt;, day_of_week &lt;ord&gt;, t_weekend &lt;lgl&gt;</code></pre>
</div>
<div id="cutoff-testing" class="section level3">
<h3><span class="header-section-number">9.2.2</span> Cutoff testing</h3>
<p>When transactions are near the end of the month (or the end of the year), cutoff testing helps establish that the transactions were recorded within the correct time period. Testing these may require selecting invoices close to month end.</p>
<p>Similar to how we calculate the period using <code>floor_date()</code>, we can take any date and transform it with <code>ceiling_date()</code> which will calculate the last date of the month. Then we can test to see if a date falls within the range as needed.</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="test.html#cb280-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb280-2"><a href="test.html#cb280-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">end_of_month =</span> <span class="kw">ceiling_date</span>(gl_date, <span class="dt">unit =</span> <span class="st">&#39;month&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb280-3"><a href="test.html#cb280-3"></a><span class="st">  </span><span class="kw">select</span>(gl_date, end_of_month) <span class="op">%&gt;%</span></span>
<span id="cb280-4"><a href="test.html#cb280-4"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   gl_date    end_of_month
##   &lt;date&gt;     &lt;date&gt;      
## 1 2019-12-02 2020-01-01  
## 2 2019-12-02 2020-01-01  
## 3 2019-11-28 2019-12-01  
## 4 2019-11-28 2019-12-01  
## 5 2019-04-09 2019-05-01  
## 6 2019-04-09 2019-05-01</code></pre>
<p>This is close to our desired result, but all these dates are representative of the beginning of the following month. To transform dates, simply use the unit as desired and treat it like a <a href="cleaning-data.html#differences-between-time">math calculation</a>. As all these dates are one day ahead, a <code>days</code> difference calculation will suffice:</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="test.html#cb282-1"></a>gl &lt;-<span class="st"> </span>gl <span class="op">%&gt;%</span></span>
<span id="cb282-2"><a href="test.html#cb282-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">end_of_month =</span> <span class="kw">ceiling_date</span>(gl_date, <span class="dt">unit =</span> <span class="st">&#39;month&#39;</span>) <span class="op">-</span><span class="st"> </span><span class="kw">days</span>(<span class="dv">1</span>))</span>
<span id="cb282-3"><a href="test.html#cb282-3"></a></span>
<span id="cb282-4"><a href="test.html#cb282-4"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb282-5"><a href="test.html#cb282-5"></a><span class="st">  </span><span class="kw">select</span>(gl_date, end_of_month) <span class="op">%&gt;%</span></span>
<span id="cb282-6"><a href="test.html#cb282-6"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   gl_date    end_of_month
##   &lt;date&gt;     &lt;date&gt;      
## 1 2019-12-02 2019-12-31  
## 2 2019-12-02 2019-12-31  
## 3 2019-11-28 2019-11-30  
## 4 2019-11-28 2019-11-30  
## 5 2019-04-09 2019-04-30  
## 6 2019-04-09 2019-04-30</code></pre>
<p>And to detect which lines are close to month end, simply calculate the difference between the end of month and the original date, keeping only dates very close to the end of the month:</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="test.html#cb284-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb284-2"><a href="test.html#cb284-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_cutoff =</span> (end_of_month <span class="op">-</span><span class="st"> </span>gl_date) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Find entries on or one day prior to month end</span></span>
<span id="cb284-3"><a href="test.html#cb284-3"></a><span class="st">  </span><span class="kw">filter</span>(t_cutoff) <span class="op">%&gt;%</span></span>
<span id="cb284-4"><a href="test.html#cb284-4"></a><span class="st">  </span><span class="kw">select</span>(je_num, gl_date, t_cutoff, <span class="kw">everything</span>())</span></code></pre></div>
<pre><code>## # A tibble: 136 x 12
##    je_num gl_date    t_cutoff  amount vendor_id account invoice_date description
##     &lt;int&gt; &lt;date&gt;     &lt;lgl&gt;      &lt;dbl&gt;     &lt;int&gt; &lt;chr&gt;   &lt;date&gt;       &lt;chr&gt;      
##  1      4 2019-10-30 TRUE      20037.      2612 exp_ma… 2019-10-20   Paper      
##  2      4 2019-10-30 TRUE     -20037.        NA liab_a… 2019-10-20   Paper      
##  3      6 2019-01-31 TRUE      13603.      2726 exp_ma… 2019-01-24   Medical gr…
##  4      6 2019-01-31 TRUE     -13603.        NA liab_a… 2019-01-24   Medical gr…
##  5     11 2019-07-30 TRUE       3000.      2612 exp_ma… 2019-07-20   Paper      
##  6     11 2019-07-30 TRUE      -3000.        NA liab_a… 2019-07-20   Paper      
##  7     31 2019-04-29 TRUE       9931.      2211 exp_co… 2019-04-14   Advisory s…
##  8     31 2019-04-29 TRUE      -9931.        NA liab_a… 2019-04-14   Advisory s…
##  9     44 2019-02-28 TRUE       3838.      2211 exp_ma… 2019-02-21   Packaging …
## 10     44 2019-02-28 TRUE      -3838.        NA liab_a… 2019-02-21   Packaging …
## # … with 126 more rows, and 4 more variables: paid_date &lt;date&gt;,
## #   day_of_week &lt;ord&gt;, t_weekend &lt;lgl&gt;, end_of_month &lt;date&gt;</code></pre>
</div>
<div id="age" class="section level3">
<h3><span class="header-section-number">9.2.3</span> Age</h3>
<p>Aging invoices is generally a system-ran report out of the accounting system. Independently testing these reports is one of the strongest forms of assurance, which requires an understanding of the underlying data, including calculation accuracy and completeness.</p>
<p>At its core, an aging calculation is the comparison of one date to another certain date, and then aggregating the total amount by buckets indicating a range of days. However, it gets complicated rather quick because of how different systems implement aging:</p>
<ul>
<li>Which dates are being compared - invoice dates, entry dates, paid dates and/or due dates?</li>
<li>Speaking of due dates, are you able to calculate a due date on a per-vendor (or even, per invoice) basis?</li>
<li>Are you able to run a report ‘as-of’? The as-of date is intended to help understand the outstanding balances at a specific point of time. Some accounting systems have insufficient information captured, meaning a backdated entered invoice (perhaps to a prior period) may affect the accuracy of a previous report.</li>
</ul>
<p>We will initially filter our data and only keep valid invoices, by filtering on records that are related to materials:</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="test.html#cb286-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb286-2"><a href="test.html#cb286-2"></a><span class="st">  </span><span class="kw">filter</span>(account <span class="op">==</span><span class="st"> &#39;exp_materials_6000&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># In scope invoices for aging</span></span>
<span id="cb286-3"><a href="test.html#cb286-3"></a><span class="st">  </span><span class="kw">select</span>(je_num, vendor_id, gl_date, invoice_date, paid_date)</span></code></pre></div>
<pre><code>## # A tibble: 952 x 5
##    je_num vendor_id gl_date    invoice_date paid_date 
##     &lt;int&gt;     &lt;int&gt; &lt;date&gt;     &lt;date&gt;       &lt;date&gt;    
##  1      1      2211 2019-12-02 2019-11-25   2020-01-01
##  2      2      2612 2019-11-28 2019-11-18   2019-12-21
##  3      3      2612 2019-04-09 2019-03-30   2019-05-02
##  4      4      2612 2019-10-30 2019-10-20   2019-11-22
##  5      5      2612 2019-06-04 2019-05-25   2019-06-27
##  6      6      2726 2019-01-31 2019-01-24   2019-02-03
##  7      7      2726 2019-10-21 2019-10-14   2019-10-24
##  8      8      2211 2019-04-24 2019-04-17   2019-05-24
##  9      9      2726 2019-07-10 2019-07-03   2019-07-13
## 10     10      2211 2019-06-13 2019-06-06   2019-07-13
## # … with 942 more rows</code></pre>
<p>In our GL data set, we have captured invoices (denoted as transactions against expense accounts), as well as the GL date (the day the company received the invoice), the invoice date as written by the supplier, and the date the invoice was paid.</p>
<p>With a better understanding of the dates, we can now focus on reproducing an accurate report:</p>
<ul>
<li>An invoice was recognized in our system as per the <code>gl_date</code>,</li>
<li>An invoice was considered fully paid as of the <code>paid_date</code>, and</li>
<li>The definition of age in our system is based off the <code>invoice_date</code> and an user-chosen ‘as-of’ date.</li>
</ul>
<p>We will use August 1, 2019 as our as-of date, and only include invoices that were recognized on or prior to then.</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="test.html#cb288-1"></a>as_of_date &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&#39;2019-08-01&#39;</span>)</span>
<span id="cb288-2"><a href="test.html#cb288-2"></a></span>
<span id="cb288-3"><a href="test.html#cb288-3"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb288-4"><a href="test.html#cb288-4"></a><span class="st">  </span><span class="kw">filter</span>(account <span class="op">==</span><span class="st"> &#39;exp_materials_6000&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># In scope invoices for aging</span></span>
<span id="cb288-5"><a href="test.html#cb288-5"></a><span class="st">  </span><span class="kw">select</span>(je_num, vendor_id, gl_date, invoice_date, paid_date) <span class="op">%&gt;%</span></span>
<span id="cb288-6"><a href="test.html#cb288-6"></a><span class="st">  </span><span class="kw">filter</span>(gl_date <span class="op">&lt;=</span><span class="st"> </span>as_of_date) <span class="co"># Only choose recognized invoices as of a date</span></span></code></pre></div>
<pre><code>## # A tibble: 571 x 5
##    je_num vendor_id gl_date    invoice_date paid_date 
##     &lt;int&gt;     &lt;int&gt; &lt;date&gt;     &lt;date&gt;       &lt;date&gt;    
##  1      3      2612 2019-04-09 2019-03-30   2019-05-02
##  2      5      2612 2019-06-04 2019-05-25   2019-06-27
##  3      6      2726 2019-01-31 2019-01-24   2019-02-03
##  4      8      2211 2019-04-24 2019-04-17   2019-05-24
##  5      9      2726 2019-07-10 2019-07-03   2019-07-13
##  6     10      2211 2019-06-13 2019-06-06   2019-07-13
##  7     11      2612 2019-07-30 2019-07-20   2019-08-22
##  8     12      2726 2019-06-19 2019-06-12   2019-06-22
##  9     16      2211 2019-01-18 2019-01-11   2019-02-17
## 10     17      2612 2019-02-05 2019-01-26   2019-02-28
## # … with 561 more rows</code></pre>
<p>We can also remove any paid invoices too, as they’re no longer aged as-of that date. Depending when you are running your report, an invoice may could either be paid or not paid yet.</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="test.html#cb290-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb290-2"><a href="test.html#cb290-2"></a><span class="st">  </span><span class="kw">filter</span>(account <span class="op">==</span><span class="st"> &#39;exp_materials_6000&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># In scope invoices for aging</span></span>
<span id="cb290-3"><a href="test.html#cb290-3"></a><span class="st">  </span><span class="kw">select</span>(je_num, vendor_id, gl_date, invoice_date, paid_date) <span class="op">%&gt;%</span></span>
<span id="cb290-4"><a href="test.html#cb290-4"></a><span class="st">  </span><span class="kw">filter</span>(gl_date <span class="op">&lt;=</span><span class="st"> </span>as_of_date) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Only choose recognized invoices as of a date</span></span>
<span id="cb290-5"><a href="test.html#cb290-5"></a><span class="st">  </span><span class="kw">filter</span>(paid_date <span class="op">&gt;=</span><span class="st"> </span>as_of_date <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(paid_date)) <span class="co"># Keep invoices that were not paid by the as-of date, or not paid at all yet</span></span></code></pre></div>
<pre><code>## # A tibble: 71 x 5
##    je_num vendor_id gl_date    invoice_date paid_date 
##     &lt;int&gt;     &lt;int&gt; &lt;date&gt;     &lt;date&gt;       &lt;date&gt;    
##  1     11      2612 2019-07-30 2019-07-20   2019-08-22
##  2     18      2612 2019-07-23 2019-07-13   2019-08-15
##  3     20      2211 2019-07-23 2019-07-16   2019-08-22
##  4     22      2612 2019-07-18 2019-07-08   2019-08-10
##  5     38      2211 2019-07-25 2019-07-18   2019-08-24
##  6     57      2211 2019-07-12 2019-07-05   2019-08-11
##  7     75      2211 2019-07-08 2019-07-01   2019-08-07
##  8     85      2612 2019-07-15 2019-07-05   2019-08-07
##  9     88      2612 2019-07-31 2019-07-21   2019-08-23
## 10     97      2612 2019-07-30 2019-07-20   2019-08-22
## # … with 61 more rows</code></pre>
<p>Having isolated our invoices, we can now calculate the number of aged days:</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="test.html#cb292-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb292-2"><a href="test.html#cb292-2"></a><span class="st">  </span><span class="kw">filter</span>(account <span class="op">==</span><span class="st"> &#39;exp_materials_6000&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># In scope invoices for aging</span></span>
<span id="cb292-3"><a href="test.html#cb292-3"></a><span class="st">  </span><span class="kw">filter</span>(gl_date <span class="op">&lt;=</span><span class="st"> </span>as_of_date) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Only choose recognized invoices as of a date</span></span>
<span id="cb292-4"><a href="test.html#cb292-4"></a><span class="st">  </span><span class="kw">filter</span>(paid_date <span class="op">&gt;=</span><span class="st"> </span>as_of_date <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(paid_date)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Keep invoices that are not paid by the as-of date, or not paid at all yet</span></span>
<span id="cb292-5"><a href="test.html#cb292-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">aged_days =</span> <span class="kw">as.numeric</span>(as_of_date <span class="op">-</span><span class="st"> </span>invoice_date)) <span class="op">%&gt;%</span></span>
<span id="cb292-6"><a href="test.html#cb292-6"></a><span class="st">  </span><span class="kw">select</span>(invoice_date, paid_date, aged_days)</span></code></pre></div>
<pre><code>## # A tibble: 71 x 3
##    invoice_date paid_date  aged_days
##    &lt;date&gt;       &lt;date&gt;         &lt;dbl&gt;
##  1 2019-07-20   2019-08-22        12
##  2 2019-07-13   2019-08-15        19
##  3 2019-07-16   2019-08-22        16
##  4 2019-07-08   2019-08-10        24
##  5 2019-07-18   2019-08-24        14
##  6 2019-07-05   2019-08-11        27
##  7 2019-07-01   2019-08-07        31
##  8 2019-07-05   2019-08-07        27
##  9 2019-07-21   2019-08-23        11
## 10 2019-07-20   2019-08-22        12
## # … with 61 more rows</code></pre>
<p>Now the most complex part is making buckets for these ages. A rather brute force way is to create a field with the range it falls in, and then eventually pivoting on it:</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="test.html#cb294-1"></a>aged_wip &lt;-<span class="st"> </span>gl <span class="op">%&gt;%</span></span>
<span id="cb294-2"><a href="test.html#cb294-2"></a><span class="st">  </span><span class="kw">filter</span>(account <span class="op">==</span><span class="st"> &#39;exp_materials_6000&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># In scope invoices for aging</span></span>
<span id="cb294-3"><a href="test.html#cb294-3"></a><span class="st">  </span><span class="kw">select</span>(je_num, account, vendor_id, gl_date, invoice_date, paid_date) <span class="op">%&gt;%</span></span>
<span id="cb294-4"><a href="test.html#cb294-4"></a><span class="st">  </span><span class="kw">filter</span>(gl_date <span class="op">&lt;=</span><span class="st"> </span>as_of_date) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Only choose recognized invoices as of a date</span></span>
<span id="cb294-5"><a href="test.html#cb294-5"></a><span class="st">  </span><span class="kw">filter</span>(paid_date <span class="op">&gt;=</span><span class="st"> </span>as_of_date <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(paid_date)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Keep invoices that are not paid by the as-of date, or not paid at all yet</span></span>
<span id="cb294-6"><a href="test.html#cb294-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">aged_days =</span> <span class="kw">as.numeric</span>(as_of_date <span class="op">-</span><span class="st"> </span>invoice_date)) <span class="op">%&gt;%</span></span>
<span id="cb294-7"><a href="test.html#cb294-7"></a><span class="st">  </span><span class="kw">select</span>(aged_days)</span>
<span id="cb294-8"><a href="test.html#cb294-8"></a></span>
<span id="cb294-9"><a href="test.html#cb294-9"></a>aged_wip <span class="op">%&gt;%</span></span>
<span id="cb294-10"><a href="test.html#cb294-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">aging_bucket =</span> <span class="kw">case_when</span>(</span>
<span id="cb294-11"><a href="test.html#cb294-11"></a>    aged_days <span class="op">&lt;</span><span class="st"> </span><span class="dv">15</span> <span class="op">~</span><span class="st"> &quot;Current&quot;</span>,</span>
<span id="cb294-12"><a href="test.html#cb294-12"></a>    aged_days <span class="op">&lt;</span><span class="st"> </span><span class="dv">30</span> <span class="op">~</span><span class="st"> &quot;15 - 30&quot;</span>,</span>
<span id="cb294-13"><a href="test.html#cb294-13"></a>    aged_days <span class="op">&lt;</span><span class="st"> </span><span class="dv">90</span> <span class="op">~</span><span class="st"> &quot;30 - 59&quot;</span>,</span>
<span id="cb294-14"><a href="test.html#cb294-14"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> &quot;60+&quot;</span></span>
<span id="cb294-15"><a href="test.html#cb294-15"></a>  ))</span></code></pre></div>
<pre><code>## # A tibble: 71 x 2
##    aged_days aging_bucket
##        &lt;dbl&gt; &lt;chr&gt;       
##  1        12 Current     
##  2        19 15 - 30     
##  3        16 15 - 30     
##  4        24 15 - 30     
##  5        14 Current     
##  6        27 15 - 30     
##  7        31 30 - 59     
##  8        27 15 - 30     
##  9        11 Current     
## 10        12 Current     
## # … with 61 more rows</code></pre>
<p>Another useful method is to use the <code>cut()</code> function, which will take the intervals you specify (aged days) and place each row into the category. The labels look a bit different - inclusive boundaries are <code>(</code> while exclusive boundaries are <code>]</code>:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="test.html#cb296-1"></a>aged_wip <span class="op">%&gt;%</span></span>
<span id="cb296-2"><a href="test.html#cb296-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">aging_bucket =</span> <span class="kw">cut</span>(aged_wip<span class="op">$</span>aged_days, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="ot">Inf</span>)))</span></code></pre></div>
<pre><code>## # A tibble: 71 x 2
##    aged_days aging_bucket
##        &lt;dbl&gt; &lt;fct&gt;       
##  1        12 (0,15]      
##  2        19 (15,30]     
##  3        16 (15,30]     
##  4        24 (15,30]     
##  5        14 (0,15]      
##  6        27 (15,30]     
##  7        31 (30,60]     
##  8        27 (15,30]     
##  9        11 (0,15]      
## 10        12 (0,15]      
## # … with 61 more rows</code></pre>
<p>You can choose which approach best fits your style. With all the pieces, we can now create the aging report, aggregated by vendor. First, lets only keep the variables we want to pivot:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="test.html#cb298-1"></a>aged &lt;-<span class="st"> </span>gl <span class="op">%&gt;%</span></span>
<span id="cb298-2"><a href="test.html#cb298-2"></a><span class="st">  </span><span class="kw">filter</span>(account <span class="op">==</span><span class="st"> &#39;exp_materials_6000&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># In scope invoices for aging</span></span>
<span id="cb298-3"><a href="test.html#cb298-3"></a><span class="st">  </span><span class="kw">filter</span>(gl_date <span class="op">&lt;=</span><span class="st"> </span>as_of_date) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Only choose recognized invoices as of a date</span></span>
<span id="cb298-4"><a href="test.html#cb298-4"></a><span class="st">  </span><span class="kw">filter</span>(paid_date <span class="op">&gt;=</span><span class="st"> </span>as_of_date <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(paid_date)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Keep invoices that are not paid by the as-of date, or not paid at all yet</span></span>
<span id="cb298-5"><a href="test.html#cb298-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">aged_days =</span> <span class="kw">as.numeric</span>(as_of_date <span class="op">-</span><span class="st"> </span>invoice_date)) <span class="op">%&gt;%</span></span>
<span id="cb298-6"><a href="test.html#cb298-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">aging_bucket =</span> <span class="kw">case_when</span>(</span>
<span id="cb298-7"><a href="test.html#cb298-7"></a>    aged_days <span class="op">&lt;</span><span class="st"> </span><span class="dv">15</span> <span class="op">~</span><span class="st"> &quot;Current&quot;</span>,</span>
<span id="cb298-8"><a href="test.html#cb298-8"></a>    aged_days <span class="op">&lt;</span><span class="st"> </span><span class="dv">30</span> <span class="op">~</span><span class="st"> &quot;15 - 30&quot;</span>,</span>
<span id="cb298-9"><a href="test.html#cb298-9"></a>    aged_days <span class="op">&lt;</span><span class="st"> </span><span class="dv">90</span> <span class="op">~</span><span class="st"> &quot;30 - 59&quot;</span>,</span>
<span id="cb298-10"><a href="test.html#cb298-10"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> &quot;60+&quot;</span></span>
<span id="cb298-11"><a href="test.html#cb298-11"></a>  )) <span class="op">%&gt;%</span></span>
<span id="cb298-12"><a href="test.html#cb298-12"></a><span class="st">  </span><span class="kw">select</span>(vendor_id, amount, aging_bucket)</span>
<span id="cb298-13"><a href="test.html#cb298-13"></a></span>
<span id="cb298-14"><a href="test.html#cb298-14"></a><span class="kw">print</span>(aged)</span></code></pre></div>
<pre><code>## # A tibble: 71 x 3
##    vendor_id amount aging_bucket
##        &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;       
##  1      2612  3000. Current     
##  2      2612  8436. 15 - 30     
##  3      2211   725. 15 - 30     
##  4      2612  5037. 15 - 30     
##  5      2211  7412. Current     
##  6      2211 11461. 15 - 30     
##  7      2211  2206. 30 - 59     
##  8      2612  2491. 15 - 30     
##  9      2612   294. Current     
## 10      2612 13593. Current     
## # … with 61 more rows</code></pre>
<p>Since our typical aging report has vendors along the left (the unique identifier for <code>id_cols</code> argument), aging buckets along the top (the names we want to spread across with <code>names_from</code>) and the amount is a summation of the valid values (<code>values_from</code> and also <code>values_fn</code>), we can use <code>pivot_wider()</code> to recreate our report:</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="test.html#cb300-1"></a>aged <span class="op">%&gt;%</span></span>
<span id="cb300-2"><a href="test.html#cb300-2"></a><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">id_cols =</span> vendor_id, <span class="dt">names_from =</span> aging_bucket, <span class="dt">values_from =</span> amount, <span class="dt">values_fn =</span> sum)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##   vendor_id Current `15 - 30` `30 - 59`
##       &lt;int&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1      2612  58163.    57468.    41684.
## 2      2211 120974.   114429.   136315.
## 3      2726 105586.       NA        NA</code></pre>
</div>
</div>
<div id="basic-statistical-tests" class="section level2">
<h2><span class="header-section-number">9.3</span> Basic Statistical tests</h2>
<p>In the <a href="exploring-data.html#explore-stats">exploration of data</a>, we highlighted that exploring your data using various statistical functions are useful for helping understand the shape of your data. After doing so, you can then apply statistical methods directly in your testing to help select samples.</p>
<div id="outliers-based-on-amount" class="section level3">
<h3><span class="header-section-number">9.3.1</span> Outliers based on amount</h3>
<blockquote>
<p>An outlier is an observation that lies an abnormal distance from other values in a random sample from a population. In a sense, this definition leaves it up to the analyst (or a consensus process) to decide what will be considered abnormal. Before abnormal observations can be singled out, it is necessary to characterize normal observations. <span class="citation">(<em>NIST/Sematech E-Handbook of Statistical Methods</em>, <a href="#ref-outliers" role="doc-biblioref">n.d.</a>)</span></p>
</blockquote>
<p>Our general approach to using statistical tests is to bring attention to “abnormal” entries in our data. Abnormal may be different depending on the situation, but items that stand apart from the rest are of audit interest.</p>
<p>Outliers are very specific to the dataset we are analyzing, and are highly dependent on the nature and structure of the work we have.</p>
<p>The most basic detection of extreme outliers can be done on an amount, looking for material transactions, by using the quantiles and IQRs. Quantiles indicate the thresholds where amounts may be in the bottom 25% or above the top 75% of data points. The IQR is defined as the difference between the upper 75% quantile and lower 25% quantile (i.e. the 3rd quartile and 1st quartile).</p>
<p>The extreme outlier test is defined as points less than the 25% quantile minus 1.5 * inter quartile range (IQR), or above the 75% quantile plus 1.5 * IQR.</p>
<p>In this case, we want to detect items greater than the extreme upper outlier:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="test.html#cb302-1"></a><span class="co"># Detect amounts in the top 25% of transactions</span></span>
<span id="cb302-2"><a href="test.html#cb302-2"></a>top_<span class="dv">75</span> &lt;-<span class="st"> </span><span class="kw">quantile</span>(<span class="kw">abs</span>(gl<span class="op">$</span>amount))[<span class="dv">4</span>] <span class="co"># This is the 3st quartile, or the 75% quantile</span></span>
<span id="cb302-3"><a href="test.html#cb302-3"></a>iqr &lt;-<span class="st"> </span><span class="kw">IQR</span>(<span class="kw">abs</span>(gl<span class="op">$</span>amount))</span>
<span id="cb302-4"><a href="test.html#cb302-4"></a>upper_extreme_outlier &lt;-<span class="st"> </span>top_<span class="dv">75</span> <span class="op">+</span><span class="st"> </span>iqr <span class="op">*</span><span class="st"> </span><span class="fl">1.5</span></span>
<span id="cb302-5"><a href="test.html#cb302-5"></a></span>
<span id="cb302-6"><a href="test.html#cb302-6"></a><span class="kw">print</span>(<span class="kw">paste0</span>(<span class="st">&quot;The upper_extreme_outlier is $&quot;</span>, upper_extreme_outlier))</span></code></pre></div>
<pre><code>## [1] &quot;The upper_extreme_outlier is $31929.19125&quot;</code></pre>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="test.html#cb304-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb304-2"><a href="test.html#cb304-2"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(amount <span class="op">&gt;</span><span class="st"> </span>upper_extreme_outlier) <span class="op">%&gt;%</span></span>
<span id="cb304-3"><a href="test.html#cb304-3"></a><span class="st">  </span><span class="kw">select</span>(je_num, amount, account, description) <span class="op">%&gt;%</span></span>
<span id="cb304-4"><a href="test.html#cb304-4"></a><span class="st">  </span><span class="kw">arrange</span>(description)</span></code></pre></div>
<pre><code>## # A tibble: 46 x 4
##    je_num amount account            description            
##     &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;              &lt;chr&gt;                  
##  1      5 43140. exp_materials_6000 Blue dye               
##  2    430 37341. exp_materials_6000 Blue dye               
##  3    825 36918. exp_materials_6000 Blue dye               
##  4     70 32584. exp_materials_6000 Fabric cutting machines
##  5    427 44950. exp_materials_6000 Fabric cutting machines
##  6     54 35758. exp_materials_6000 Face mask elastics     
##  7    531 42785. exp_materials_6000 Face mask elastics     
##  8    680 36860. exp_materials_6000 Fancy cloth prints     
##  9    832 37269. exp_materials_6000 Fancy cloth prints     
## 10     66 51347. exp_materials_6000 Medical grade filters  
## # … with 36 more rows</code></pre>
</div>
<div id="outliers-based-on-amounts-and-other-factors" class="section level3">
<h3><span class="header-section-number">9.3.2</span> Outliers based on amounts and other factors</h3>
<p>By performing a test based solely on amounts alone, other meaningful data is ignored. The nuances of specific subsets of data are lost due to an overarching amount analysis, which could be too crude.</p>
<p>There are other useful features in our dataset we can use to potentially segment the data. There is the account information, which can be interpreted as consistent categories of information. There are also descriptions, which help us understand more granular detail about the nature of the transaction. A combination of any identifying categories or factors could be used to identify outliers.</p>
<p>If we focus our analysis on both the description and amount, we can identify amount extreme outliers on a more unique basis. First, we need to group the descriptions and independently calculate the <code>upper_extreme_outlier</code> on a per group basis:</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="test.html#cb306-1"></a>outliers_per_desc &lt;-<span class="st"> </span>gl <span class="op">%&gt;%</span></span>
<span id="cb306-2"><a href="test.html#cb306-2"></a><span class="st">  </span><span class="kw">group_by</span>(description) <span class="op">%&gt;%</span></span>
<span id="cb306-3"><a href="test.html#cb306-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>(),</span>
<span id="cb306-4"><a href="test.html#cb306-4"></a>            <span class="dt">upper_limit =</span> <span class="kw">quantile</span>(<span class="kw">abs</span>(amount))[<span class="dv">4</span>],</span>
<span id="cb306-5"><a href="test.html#cb306-5"></a>            <span class="dt">iqr =</span> <span class="kw">IQR</span>(<span class="kw">abs</span>(amount))) <span class="op">%&gt;%</span></span>
<span id="cb306-6"><a href="test.html#cb306-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">upper_extreme_outlier =</span> upper_limit <span class="op">+</span><span class="st"> </span><span class="fl">1.5</span> <span class="op">*</span><span class="st"> </span>iqr)</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="test.html#cb308-1"></a><span class="kw">print</span>(outliers_per_desc)</span></code></pre></div>
<pre><code>## # A tibble: 25 x 5
##    description                       count upper_limit    iqr upper_extreme_out…
##    &lt;chr&gt;                             &lt;int&gt;       &lt;dbl&gt;  &lt;dbl&gt;              &lt;dbl&gt;
##  1 Advisory fee for face mask manuf…    10       9277. 1.84e2              9552.
##  2 Advisory services for tax expats     24       9897. 3.53e2             10427.
##  3 Audit fees for big four audit fi…    10       9788. 4.73e2             10497.
##  4 Blue dye                             80      14581. 1.20e4             32509.
##  5 Buffet                                4        156. 3.76e1               212.
##  6 Catering                              8        120. 7.26e1               229.
##  7 Consulting fee on how to adhere …     6       9784. 5.14e2             10556.
##  8 Fabric cutting machines              68      15591. 1.31e4             35204.
##  9 Face mask elastics                   74      13461. 1.10e4             30007.
## 10 Facilitation payment to agent fi…     2       9715. 0.                  9715.
## # … with 15 more rows</code></pre>
<p>Using this, we can quickly look up the <code>upper_extreme_outlier</code> in our gl table, and reduce our scope to only filter amounts greater than the limit per description entry.</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="test.html#cb310-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb310-2"><a href="test.html#cb310-2"></a><span class="st">  </span><span class="kw">left_join</span>(outliers_per_desc, <span class="dt">by =</span> <span class="st">&#39;description&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb310-3"><a href="test.html#cb310-3"></a><span class="st">  </span><span class="kw">filter</span>(amount <span class="op">&gt;=</span><span class="st"> </span>upper_extreme_outlier) <span class="op">%&gt;%</span></span>
<span id="cb310-4"><a href="test.html#cb310-4"></a><span class="st">  </span><span class="kw">select</span>(je_num, amount, account, description, upper_extreme_outlier) <span class="op">%&gt;%</span></span>
<span id="cb310-5"><a href="test.html#cb310-5"></a><span class="st">  </span><span class="kw">group_by</span>(description) <span class="op">%&gt;%</span></span>
<span id="cb310-6"><a href="test.html#cb310-6"></a><span class="st">  </span><span class="kw">slice_max</span>(<span class="dt">order_by =</span> amount, <span class="dt">n =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## # A tibble: 33 x 5
## # Groups:   description [14]
##    je_num  amount account        description                  upper_extreme_out…
##     &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;                                     &lt;dbl&gt;
##  1    975  9834.  exp_consultin… Advisory fee for face mask …             9552. 
##  2      5 43140.  exp_materials… Blue dye                                32509. 
##  3    430 37341.  exp_materials… Blue dye                                32509. 
##  4    825 36918.  exp_materials… Blue dye                                32509. 
##  5    427 44950.  exp_materials… Fabric cutting machines                 35204. 
##  6    531 42785.  exp_materials… Face mask elastics                      30007. 
##  7     54 35758.  exp_materials… Face mask elastics                      30007. 
##  8    755  9715.  exp_consultin… Facilitation payment to age…             9715. 
##  9    335    52.2 exp_meals_7000 Italian food restaurant                    52.2
## 10    309  1630.  exp_materials… Meals for launch celebration             1630. 
## # … with 23 more rows</code></pre>
<p>The results are different than the outliers based solely on the amount, and are a good evaluation on a per-group basis.</p>
</div>
</div>
<div id="unusual-pattern-and-behaviours" class="section level2">
<h2><span class="header-section-number">9.4</span> Unusual pattern and behaviours</h2>
<div id="benfords-law-analysis" class="section level3">
<h3><span class="header-section-number">9.4.1</span> Benford’s Law analysis</h3>
<p>The general principle of fraud detection is that individuals behave differently when they attempt to conceal, manipulate or make up information, as the fictional creation of numbers by people is different than how the accounting world behaves. As a result, these behaviours tend to stand out when certain tests are applied to them.</p>
<p>Benford’s Law is a common application in the accounting and auditing, as it is a quick litmus test to see if there are symptoms of anomalies in a dataset. The law generally states that in a set of values, the leading digit of 1 will occur more often than the leading digit of 2, the leading digit of 2 will naturally occur more often than the leading digit of 3, etc.. With a sufficiently large population, you can reasonably estimate the number of times a leading digit should appear a certain number of times.</p>
<p>Think about the general working population and hourly wages. You could reasonably assume that its relatively accessible to get a job that pays $10-$19/hr. Its more difficult to get a job with $20-$29/hr wage, and even more so to get a job with $90-$99/hr wage.</p>
<p>What is fascinating is that once you reach the next digit, the wages all start with 1’s again, and it takes a lot of effort to get out of the $100-$199/hr band. This type of scaling means its increasingly harder for individuals to get a higher hourly salary. While there are some lucky folks that earn $200/hr, those individuals are more rare than those who earn $20/hr.</p>
<p>With Benford’s Law and applying the concept to a population of natural numbers, then the concept of leading digits makes intuitive sense. There will be more salaries that start with 1, than with 2, etc. You could estimate that a reasonable proportion of hourly wages could look like this:</p>
<p><img src="Audit_Analytics_with-R_files/figure-html/unnamed-chunk-107-1.png" width="672" /></p>
<p>If we assume the first dataset is an example of a generally real world dataset, then lets look at a completely fictional dataset. For example, lets say in a range of 1 to 999, we randomly sample 1000 numbers and apply the Benford Law, we will notice the following:</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="test.html#cb312-1"></a>benford_sample &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">seq =</span> <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">999</span>, <span class="dv">1000</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>))</span>
<span id="cb312-2"><a href="test.html#cb312-2"></a>benford_sample<span class="op">$</span>leading &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substr</span>(benford_sample<span class="op">$</span>seq, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb312-3"><a href="test.html#cb312-3"></a></span>
<span id="cb312-4"><a href="test.html#cb312-4"></a>benford_sample <span class="op">%&gt;%</span></span>
<span id="cb312-5"><a href="test.html#cb312-5"></a><span class="st">  </span><span class="kw">group_by</span>(leading) <span class="op">%&gt;%</span></span>
<span id="cb312-6"><a href="test.html#cb312-6"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">times_occured =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb312-7"><a href="test.html#cb312-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">as.factor</span>(leading), <span class="dt">y =</span> times_occured)) <span class="op">+</span></span>
<span id="cb312-8"><a href="test.html#cb312-8"></a><span class="st">    </span><span class="kw">geom_col</span>()</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<p><img src="Audit_Analytics_with-R_files/figure-html/unnamed-chunk-108-1.png" width="672" /></p>
<p>Notice how uniform the bars appear. The sample we chose was essentially made-up numbers between 1 and 999, the computer would choose these with equal probability, unlike the population of hourly wages, leading to a graph that does not follow the curve of Benford’s Law.</p>
<div id="applying-benfords-law" class="section level4">
<h4><span class="header-section-number">9.4.1.1</span> Applying Benford’s Law</h4>
<p>Several statistical tests exist to determine whether or not a population conforms to Benford’s Law. While chi-square tests are numerically ‘authoritative’, remember that the individuals samples will indicate whether or not fraud truly exists.</p>
<p>In application, Benford’s Law requires professional judgment, and there can be any number of reasons why a population doesn’t follow it. My successful experiences as an auditor have been to chart the actual proportion of leading digits against a curve of the expected outcome, and determine if there are any business reasons that may rationalize a pattern in the data before I perform further sampling.</p>
<p>To calculate the curve, you need to determine the likelihood that each digit should appear. The expected proportion for each digit can be calculated as follows:</p>
<p><span class="math display">\[log_{10}\left( 1 + \frac{1}{d}\right)\]</span></p>
<p>In R, this is represented as:</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="test.html#cb314-1"></a>d &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># Leading digit</span></span>
<span id="cb314-2"><a href="test.html#cb314-2"></a><span class="kw">log10</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>d)</span></code></pre></div>
<pre><code>## [1] 0.30103</code></pre>
<p>We can create a quick reference curve of the leading digits for Benford’s Law:</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="test.html#cb316-1"></a>benford_curve &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">digit =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>) <span class="op">%&gt;%</span></span>
<span id="cb316-2"><a href="test.html#cb316-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob =</span> <span class="kw">log10</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>digit),</span>
<span id="cb316-3"><a href="test.html#cb316-3"></a>         <span class="dt">curve =</span> <span class="st">&#39;benford&#39;</span>)</span>
<span id="cb316-4"><a href="test.html#cb316-4"></a></span>
<span id="cb316-5"><a href="test.html#cb316-5"></a><span class="kw">ggplot</span>(benford_curve, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">as.factor</span>(digit), <span class="dt">y =</span> prob, <span class="dt">group =</span> curve)) <span class="op">+</span></span>
<span id="cb316-6"><a href="test.html#cb316-6"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&#39;red&#39;</span>) <span class="op">+</span></span>
<span id="cb316-7"><a href="test.html#cb316-7"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="Audit_Analytics_with-R_files/figure-html/unnamed-chunk-110-1.png" width="672" /></p>
<p>We can then take any of our populations, create the bar chart, and then apply the expected proportions of Benford’s Law to it. Lets take our GL database and create the proportion of how often each leading digit occurs. Note we will try to follow the same variable structure as <code>benford_curve</code>, as we will combine these on the same chart.</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="test.html#cb317-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb317-2"><a href="test.html#cb317-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">digit =</span> <span class="kw">as.numeric</span>(<span class="kw">substr</span>(amount, <span class="dv">1</span>, <span class="dv">1</span>))) <span class="op">%&gt;%</span></span>
<span id="cb317-3"><a href="test.html#cb317-3"></a><span class="st">  </span><span class="kw">group_by</span>(digit) <span class="op">%&gt;%</span></span>
<span id="cb317-4"><a href="test.html#cb317-4"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">times_occured =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb317-5"><a href="test.html#cb317-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> times_occured <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(times_occured),</span>
<span id="cb317-6"><a href="test.html#cb317-6"></a>         <span class="dt">curve =</span> <span class="st">&#39;actual&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb317-7"><a href="test.html#cb317-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">as.factor</span>(digit), <span class="dt">y =</span> prop)) <span class="op">+</span></span>
<span id="cb317-8"><a href="test.html#cb317-8"></a><span class="st">    </span><span class="kw">geom_col</span>()</span></code></pre></div>
<p><img src="Audit_Analytics_with-R_files/figure-html/unnamed-chunk-111-1.png" width="672" /></p>
<p>Notice in our chart that there are several NAs. In our dataset, we have several negative numbers (as journal entry credits as represented with negatives), and extracting the first character using <code>substr()</code> will retrieve the negative symbol. You may choose to perform Benford’s Law on the positive and negative numbers, separately or together, transforming the negative numbers with <code>abs()</code>. You can also choose to exclude them, as I do below:</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="test.html#cb318-1"></a>actuals &lt;-<span class="st"> </span>gl <span class="op">%&gt;%</span></span>
<span id="cb318-2"><a href="test.html#cb318-2"></a><span class="st">  </span><span class="kw">filter</span>(amount <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb318-3"><a href="test.html#cb318-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">digit =</span> <span class="kw">as.numeric</span>(<span class="kw">substr</span>(amount, <span class="dv">1</span>, <span class="dv">1</span>))) <span class="op">%&gt;%</span></span>
<span id="cb318-4"><a href="test.html#cb318-4"></a><span class="st">  </span><span class="kw">group_by</span>(digit) <span class="op">%&gt;%</span></span>
<span id="cb318-5"><a href="test.html#cb318-5"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">times_occured =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb318-6"><a href="test.html#cb318-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prop =</span> times_occured <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(times_occured),</span>
<span id="cb318-7"><a href="test.html#cb318-7"></a>         <span class="dt">curve =</span> <span class="st">&#39;actual&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb318-8"><a href="test.html#cb318-8"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">as.factor</span>(digit), <span class="dt">y =</span> prop)) <span class="op">+</span></span>
<span id="cb318-9"><a href="test.html#cb318-9"></a><span class="st">    </span><span class="kw">geom_col</span>()</span>
<span id="cb318-10"><a href="test.html#cb318-10"></a></span>
<span id="cb318-11"><a href="test.html#cb318-11"></a>actuals</span></code></pre></div>
<p><img src="Audit_Analytics_with-R_files/figure-html/unnamed-chunk-112-1.png" width="672" /></p>
<p>Now that we have the actual proportions, lets layer on the <code>benford_curve</code> we created:</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="test.html#cb319-1"></a>actuals <span class="op">+</span></span>
<span id="cb319-2"><a href="test.html#cb319-2"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> benford_curve, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">as.factor</span>(digit), <span class="dt">y =</span> prob, <span class="dt">group =</span> curve), <span class="dt">color =</span> <span class="st">&#39;red&#39;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb319-3"><a href="test.html#cb319-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> benford_curve, <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">as.factor</span>(digit), <span class="dt">y =</span> prob), <span class="dt">color =</span> <span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="Audit_Analytics_with-R_files/figure-html/unnamed-chunk-113-1.png" width="672" /></p>
<p>When you reach this stage, take a moment to pause and understand the business, and if there may be any potential behavours to cause potential curve differences. For example, if there is an approval ‘limit’ that exists at $1000, you may see a spike of entries at the 9 leading digit.</p>
<p>As with any statistical test, Benford’s Law will not give you an answer as to why there may be fraud. There may be both legitimate reasons for why populations do not follow Benford’s Law. A higher than expected proportion of leading digits starting with 9 does not mean those numbers starting with 9 are fraudulent.</p>
</div>
<div id="more-leading-digits" class="section level4">
<h4><span class="header-section-number">9.4.1.2</span> More leading digits?</h4>
<p>You can get any number of leading digits to apply Benford’s Law - to do so, you need to start on the lowest possible value for the number of digits desired, to remove leading zeros, and extend the sequence to the highest number before a new digit must be added. For example, two leading digits would have a sequence of numbers created from 10:99, and three leading digits would be 100:999:</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="test.html#cb320-1"></a>benford_curve_leading2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">digit =</span> <span class="dv">10</span><span class="op">:</span><span class="dv">99</span>) <span class="op">%&gt;%</span></span>
<span id="cb320-2"><a href="test.html#cb320-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prob =</span> <span class="kw">log10</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>digit),</span>
<span id="cb320-3"><a href="test.html#cb320-3"></a>         <span class="dt">curve =</span> <span class="st">&#39;benford&#39;</span>)</span>
<span id="cb320-4"><a href="test.html#cb320-4"></a></span>
<span id="cb320-5"><a href="test.html#cb320-5"></a><span class="kw">head</span>(benford_curve_leading2)</span></code></pre></div>
<pre><code>##   digit       prob   curve
## 1    10 0.04139269 benford
## 2    11 0.03778856 benford
## 3    12 0.03476211 benford
## 4    13 0.03218468 benford
## 5    14 0.02996322 benford
##  [ reached &#39;max&#39; / getOption(&quot;max.print&quot;) -- omitted 1 rows ]</code></pre>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="test.html#cb322-1"></a><span class="kw">tail</span>(benford_curve_leading2)</span></code></pre></div>
<pre><code>##    digit        prob   curve
## 85    94 0.004595752 benford
## 86    95 0.004547628 benford
## 87    96 0.004500501 benford
## 88    97 0.004454341 benford
## 89    98 0.004409119 benford
##  [ reached &#39;max&#39; / getOption(&quot;max.print&quot;) -- omitted 1 rows ]</code></pre>
</div>
</div>
<div id="relative-size-factor-rsf" class="section level3">
<h3><span class="header-section-number">9.4.2</span> Relative size factor (RSF)</h3>
<p>The Relative Size Factor test is the comparison of “large amounts to a benchmark to see how large they are relative to some norm.” <span class="citation">(<em>Identifying Anomalies Using the Relative Size Factor Test</em> <a href="#ref-nigrini-forensicanalytics-ch11" role="doc-biblioref">2012</a>)</span>. The calculation is done by taking the largest value divided by the second largest value within a group. Examples of groups include a listing of payables for a vendor, or the expenses completed by an employee. A larger RSF indicates that there was a larger proportional between the largest and second largest invoice.</p>
<p>One test is to determining the vendors top two invoice amounts and their RSF ratio. Recall the <code>group_by()</code> will perform the calculation at the level requested - adding <code>slice_max()</code> will select the highest row of values by the group.</p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="test.html#cb324-1"></a>top_two_per_vendor &lt;-<span class="st"> </span>gl <span class="op">%&gt;%</span></span>
<span id="cb324-2"><a href="test.html#cb324-2"></a><span class="st">  </span><span class="kw">filter</span>(account <span class="op">==</span><span class="st"> &#39;exp_materials_6000&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb324-3"><a href="test.html#cb324-3"></a><span class="st">  </span><span class="kw">select</span>(vendor_id, je_num, amount) <span class="op">%&gt;%</span></span>
<span id="cb324-4"><a href="test.html#cb324-4"></a><span class="st">  </span><span class="kw">group_by</span>(vendor_id) <span class="op">%&gt;%</span></span>
<span id="cb324-5"><a href="test.html#cb324-5"></a><span class="st">  </span><span class="kw">slice_max</span>(amount, <span class="dt">n =</span> <span class="dv">2</span>)</span>
<span id="cb324-6"><a href="test.html#cb324-6"></a></span>
<span id="cb324-7"><a href="test.html#cb324-7"></a>top_two_per_vendor</span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
## # Groups:   vendor_id [3]
##   vendor_id je_num amount
##       &lt;int&gt;  &lt;int&gt;  &lt;dbl&gt;
## 1      2211    140 96355.
## 2      2211    555 57258.
## 3      2612    583 47748.
## 4      2612    337 46066.
## 5      2726    693 88524.
## 6      2726    756 57567.</code></pre>
<p>Since we’ve identified the top two invoices per <code>vendor_id</code>, we’ve artifically also created new max and mins for the group, which we can use to calculate our RSF:</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="test.html#cb326-1"></a>top_two_per_vendor <span class="op">%&gt;%</span></span>
<span id="cb326-2"><a href="test.html#cb326-2"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">rsf =</span> <span class="kw">max</span>(amount) <span class="op">/</span><span class="st"> </span><span class="kw">min</span>(amount))</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   vendor_id   rsf
##       &lt;int&gt; &lt;dbl&gt;
## 1      2211  1.68
## 2      2612  1.04
## 3      2726  1.54</code></pre>
<p>This test may reveal invoices that may have been miskeyed with extra zeros, or conversely, identify large one-time orders.</p>
</div>
<div id="duplicate-invoices" class="section level3">
<h3><span class="header-section-number">9.4.3</span> Duplicate Invoices</h3>
<p>Detection of duplicates are a seemingly simple concept. For invoices, find an invoice with the same invoice date and same amount. Experience will tell you that detecting suspected duplicates and generating a list is easy, and unfortunately there will be a significant number of false positives to wade through. We will go through the basics of duplicate detection with invoices, and then determine additional strategies you can apply to rule out unlikely samples. These same strategies can be applied across any type of payable.</p>
<p>The initial approach is built off the Same-Same-Same or Same-Same-Different duplicate detection approach <span class="citation">(<em>Identifying Fraud Using Abnormal Duplications Within Subsets</em> <a href="#ref-nigrini-forensicanalytics-ch12" role="doc-biblioref">2012</a>)</span>. Essentially, you examine for factors where the may be similarities in the key fields, and potentially differences in one of them. Here is a fictional dataset to illustrate how data may be represented.</p>
<p>Note that despite the name, there can be as many ‘Same’ key fields as needed.</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb328-1"><a href="test.html#cb328-1"></a>invoices &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">system_id =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">7</span>,</span>
<span id="cb328-2"><a href="test.html#cb328-2"></a>           <span class="dt">invoice_id =</span> <span class="kw">c</span>(<span class="st">&#39;156&#39;</span>, <span class="st">&#39;156&#39;</span>, <span class="st">&#39;157A&#39;</span>, <span class="st">&#39;157B&#39;</span>, <span class="st">&#39;158&#39;</span>, <span class="st">&#39;159&#39;</span>, <span class="st">&#39;160&#39;</span>), </span>
<span id="cb328-3"><a href="test.html#cb328-3"></a>           <span class="dt">date =</span> <span class="kw">c</span>(<span class="kw">as.Date</span>(<span class="st">&#39;2019-01-01&#39;</span>), <span class="kw">as.Date</span>(<span class="st">&#39;2019-01-01&#39;</span>), <span class="kw">as.Date</span>(<span class="st">&#39;2019-01-02&#39;</span>), <span class="kw">as.Date</span>(<span class="st">&#39;2019-01-02&#39;</span>), <span class="kw">as.Date</span>(<span class="st">&#39;2019-01-03&#39;</span>), <span class="kw">as.Date</span>(<span class="st">&#39;2019-01-03&#39;</span>), <span class="kw">as.Date</span>(<span class="st">&#39;2019-01-04&#39;</span>)),</span>
<span id="cb328-4"><a href="test.html#cb328-4"></a>           <span class="dt">amount =</span> <span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">1000</span>, <span class="dv">2500</span>, <span class="dv">2500</span>, <span class="dv">3000</span>, <span class="dv">3000</span>, <span class="dv">4000</span>),</span>
<span id="cb328-5"><a href="test.html#cb328-5"></a>           <span class="dt">acctcode =</span> <span class="kw">c</span>(<span class="dv">6100</span>, <span class="dv">6100</span>, <span class="dv">6200</span>, <span class="dv">6200</span>, <span class="dv">6100</span>, <span class="dv">6200</span>, <span class="dv">6100</span>))</span>
<span id="cb328-6"><a href="test.html#cb328-6"></a></span>
<span id="cb328-7"><a href="test.html#cb328-7"></a>invoices <span class="op">%&gt;%</span></span>
<span id="cb328-8"><a href="test.html#cb328-8"></a><span class="st">  </span><span class="kw">gt</span>() <span class="co"># We&#39;ll hide this table-making code in future chunks. For now, its going to make our table prettier</span></span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#apypylgndp .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#apypylgndp .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#apypylgndp .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#apypylgndp .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#apypylgndp .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#apypylgndp .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#apypylgndp .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#apypylgndp .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#apypylgndp .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#apypylgndp .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#apypylgndp .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#apypylgndp .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#apypylgndp .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#apypylgndp .gt_from_md > :first-child {
  margin-top: 0;
}

#apypylgndp .gt_from_md > :last-child {
  margin-bottom: 0;
}

#apypylgndp .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#apypylgndp .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#apypylgndp .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#apypylgndp .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#apypylgndp .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#apypylgndp .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#apypylgndp .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#apypylgndp .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#apypylgndp .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#apypylgndp .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#apypylgndp .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#apypylgndp .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#apypylgndp .gt_left {
  text-align: left;
}

#apypylgndp .gt_center {
  text-align: center;
}

#apypylgndp .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#apypylgndp .gt_font_normal {
  font-weight: normal;
}

#apypylgndp .gt_font_bold {
  font-weight: bold;
}

#apypylgndp .gt_font_italic {
  font-style: italic;
}

#apypylgndp .gt_super {
  font-size: 65%;
}

#apypylgndp .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="apypylgndp" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">system_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">acctcode</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_left">157A</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_left">157B</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_left">158</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6100</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">6</td>
      <td class="gt_row gt_left">159</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6200</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">7</td>
      <td class="gt_row gt_left">160</td>
      <td class="gt_row gt_left">2019-01-04</td>
      <td class="gt_row gt_right">4000</td>
      <td class="gt_row gt_right">6100</td>
    </tr>
  </tbody>
  
  
</table></div>
<div id="same-same-same" class="section level4">
<h4><span class="header-section-number">9.4.3.1</span> Same-Same-Same</h4>
<p>To run our Same-Same-Same test, we would collect the key fields we would like to use. In this case, the invoice, date and amount could qualify as key fields - Same Invoice ID, Same Date, Same Amount. You would summarize by how often that combination appears, only keeping items that match more than once:</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="test.html#cb329-1"></a>dupes_set1 &lt;-<span class="st"> </span>invoices <span class="op">%&gt;%</span></span>
<span id="cb329-2"><a href="test.html#cb329-2"></a><span class="st">  </span><span class="kw">group_by</span>(invoice_id, date, amount) <span class="op">%&gt;%</span></span>
<span id="cb329-3"><a href="test.html#cb329-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">times_occured =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb329-4"><a href="test.html#cb329-4"></a><span class="st">  </span><span class="kw">filter</span>(times_occured <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb329-5"><a href="test.html#cb329-5"></a><span class="st">  </span><span class="kw">ungroup</span>()</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#scoomxzhfk .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#scoomxzhfk .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#scoomxzhfk .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#scoomxzhfk .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#scoomxzhfk .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#scoomxzhfk .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#scoomxzhfk .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#scoomxzhfk .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#scoomxzhfk .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#scoomxzhfk .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#scoomxzhfk .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#scoomxzhfk .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#scoomxzhfk .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#scoomxzhfk .gt_from_md > :first-child {
  margin-top: 0;
}

#scoomxzhfk .gt_from_md > :last-child {
  margin-bottom: 0;
}

#scoomxzhfk .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#scoomxzhfk .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#scoomxzhfk .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#scoomxzhfk .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#scoomxzhfk .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#scoomxzhfk .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#scoomxzhfk .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#scoomxzhfk .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#scoomxzhfk .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#scoomxzhfk .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#scoomxzhfk .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#scoomxzhfk .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#scoomxzhfk .gt_left {
  text-align: left;
}

#scoomxzhfk .gt_center {
  text-align: center;
}

#scoomxzhfk .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#scoomxzhfk .gt_font_normal {
  font-weight: normal;
}

#scoomxzhfk .gt_font_bold {
  font-weight: bold;
}

#scoomxzhfk .gt_font_italic {
  font-style: italic;
}

#scoomxzhfk .gt_super {
  font-size: 65%;
}

#scoomxzhfk .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="scoomxzhfk" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">times_occured</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_center">2</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>To keep track of which invoices meet specific criteria, we will then join this information to the main dataset. This way, you’ll maintain a library of invoices that meet multiple criteria. First off, lets keep keep all the duplicate keys we summarized on, plus a unique identifier so we can match the pairs:</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="test.html#cb330-1"></a>dupes_set1 &lt;-<span class="st"> </span>dupes_set1 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb330-2"><a href="test.html#cb330-2"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Remove the grouping aspect, which affects the ranking by row_number()</span></span>
<span id="cb330-3"><a href="test.html#cb330-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_dupes1 =</span> <span class="kw">row_number</span>()) </span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#ywkhiyflph .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ywkhiyflph .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ywkhiyflph .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ywkhiyflph .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ywkhiyflph .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ywkhiyflph .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ywkhiyflph .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ywkhiyflph .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ywkhiyflph .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ywkhiyflph .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ywkhiyflph .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ywkhiyflph .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#ywkhiyflph .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ywkhiyflph .gt_from_md > :first-child {
  margin-top: 0;
}

#ywkhiyflph .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ywkhiyflph .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ywkhiyflph .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#ywkhiyflph .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ywkhiyflph .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#ywkhiyflph .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ywkhiyflph .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ywkhiyflph .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ywkhiyflph .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ywkhiyflph .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ywkhiyflph .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#ywkhiyflph .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ywkhiyflph .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#ywkhiyflph .gt_left {
  text-align: left;
}

#ywkhiyflph .gt_center {
  text-align: center;
}

#ywkhiyflph .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ywkhiyflph .gt_font_normal {
  font-weight: normal;
}

#ywkhiyflph .gt_font_bold {
  font-weight: bold;
}

#ywkhiyflph .gt_font_italic {
  font-style: italic;
}

#ywkhiyflph .gt_super {
  font-size: 65%;
}

#ywkhiyflph .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="ywkhiyflph" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">times_occured</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes1</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">1</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>Then bring it into our invoices dataset:</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb331-1"><a href="test.html#cb331-1"></a>dupes_set1 &lt;-<span class="st"> </span>dupes_set1 <span class="op">%&gt;%</span></span>
<span id="cb331-2"><a href="test.html#cb331-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>times_occured) <span class="co"># Unneeded for final result</span></span>
<span id="cb331-3"><a href="test.html#cb331-3"></a></span>
<span id="cb331-4"><a href="test.html#cb331-4"></a>invoices &lt;-<span class="st"> </span>invoices <span class="op">%&gt;%</span></span>
<span id="cb331-5"><a href="test.html#cb331-5"></a><span class="st">  </span><span class="kw">left_join</span>(dupes_set1, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;invoice_id&#39;</span>, <span class="st">&#39;date&#39;</span>, <span class="st">&#39;amount&#39;</span>))</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#yilzjrwawn .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#yilzjrwawn .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#yilzjrwawn .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#yilzjrwawn .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#yilzjrwawn .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#yilzjrwawn .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#yilzjrwawn .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#yilzjrwawn .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#yilzjrwawn .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#yilzjrwawn .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#yilzjrwawn .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#yilzjrwawn .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#yilzjrwawn .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#yilzjrwawn .gt_from_md > :first-child {
  margin-top: 0;
}

#yilzjrwawn .gt_from_md > :last-child {
  margin-bottom: 0;
}

#yilzjrwawn .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#yilzjrwawn .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#yilzjrwawn .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#yilzjrwawn .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#yilzjrwawn .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#yilzjrwawn .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#yilzjrwawn .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#yilzjrwawn .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#yilzjrwawn .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#yilzjrwawn .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#yilzjrwawn .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#yilzjrwawn .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#yilzjrwawn .gt_left {
  text-align: left;
}

#yilzjrwawn .gt_center {
  text-align: center;
}

#yilzjrwawn .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#yilzjrwawn .gt_font_normal {
  font-weight: normal;
}

#yilzjrwawn .gt_font_bold {
  font-weight: bold;
}

#yilzjrwawn .gt_font_italic {
  font-style: italic;
}

#yilzjrwawn .gt_super {
  font-size: 65%;
}

#yilzjrwawn .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="yilzjrwawn" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">system_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">acctcode</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes1</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_left">157A</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_left">157B</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_left">158</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">6</td>
      <td class="gt_row gt_left">159</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">7</td>
      <td class="gt_row gt_left">160</td>
      <td class="gt_row gt_left">2019-01-04</td>
      <td class="gt_row gt_right">4000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
  </tbody>
  
  
</table></div>
</div>
<div id="same-same-different" class="section level4">
<h4><span class="header-section-number">9.4.3.2</span> Same-Same-Different</h4>
<p>For the Same-Same-Different test, we have to add an extra step. We still collect the key fields we would like to use. In this case, perhaps we would like to check for duplicates on the same date and same amount, but now we’re looking for different invoice_ids. Therefore, Same Date, Same Amount, Different Invoice_id.</p>
<p>First, lets detect the duplicates on our key fields:</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="test.html#cb332-1"></a>dupes_set2 &lt;-<span class="st"> </span>invoices <span class="op">%&gt;%</span></span>
<span id="cb332-2"><a href="test.html#cb332-2"></a><span class="st">  </span><span class="kw">group_by</span>(invoice_id, date, amount) <span class="op">%&gt;%</span></span>
<span id="cb332-3"><a href="test.html#cb332-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">times_occured =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb332-4"><a href="test.html#cb332-4"></a><span class="st">  </span><span class="kw">ungroup</span>()</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#jwsjijnxly .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#jwsjijnxly .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jwsjijnxly .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#jwsjijnxly .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#jwsjijnxly .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jwsjijnxly .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jwsjijnxly .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#jwsjijnxly .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#jwsjijnxly .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#jwsjijnxly .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#jwsjijnxly .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#jwsjijnxly .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#jwsjijnxly .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#jwsjijnxly .gt_from_md > :first-child {
  margin-top: 0;
}

#jwsjijnxly .gt_from_md > :last-child {
  margin-bottom: 0;
}

#jwsjijnxly .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#jwsjijnxly .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#jwsjijnxly .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jwsjijnxly .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#jwsjijnxly .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jwsjijnxly .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#jwsjijnxly .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#jwsjijnxly .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jwsjijnxly .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jwsjijnxly .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#jwsjijnxly .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jwsjijnxly .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#jwsjijnxly .gt_left {
  text-align: left;
}

#jwsjijnxly .gt_center {
  text-align: center;
}

#jwsjijnxly .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#jwsjijnxly .gt_font_normal {
  font-weight: normal;
}

#jwsjijnxly .gt_font_bold {
  font-weight: bold;
}

#jwsjijnxly .gt_font_italic {
  font-style: italic;
}

#jwsjijnxly .gt_super {
  font-size: 65%;
}

#jwsjijnxly .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="jwsjijnxly" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">times_occured</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_center">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">157A</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">157B</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">158</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">159</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">160</td>
      <td class="gt_row gt_left">2019-01-04</td>
      <td class="gt_row gt_right">4000</td>
      <td class="gt_row gt_center">1</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>Then, you perform another <code>group_by</code>, but this time just on the ones that are the same. In this case, that would be Date and Amount.</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="test.html#cb333-1"></a>dupes_set2 &lt;-<span class="st"> </span>dupes_set2 <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Remove the grouping aspect, which is kept by default in dplyr</span></span>
<span id="cb333-2"><a href="test.html#cb333-2"></a><span class="st">  </span><span class="kw">group_by</span>(date, amount) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Second set of reductions, but this time, find how many unique invoice ids there are per date-amount</span></span>
<span id="cb333-3"><a href="test.html#cb333-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">times_occured =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb333-4"><a href="test.html#cb333-4"></a><span class="st">  </span><span class="kw">filter</span>(times_occured <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb333-5"><a href="test.html#cb333-5"></a><span class="st">  </span><span class="kw">ungroup</span>()</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#sbhqhjfqdz .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#sbhqhjfqdz .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#sbhqhjfqdz .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#sbhqhjfqdz .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#sbhqhjfqdz .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#sbhqhjfqdz .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#sbhqhjfqdz .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#sbhqhjfqdz .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#sbhqhjfqdz .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#sbhqhjfqdz .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#sbhqhjfqdz .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#sbhqhjfqdz .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#sbhqhjfqdz .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#sbhqhjfqdz .gt_from_md > :first-child {
  margin-top: 0;
}

#sbhqhjfqdz .gt_from_md > :last-child {
  margin-bottom: 0;
}

#sbhqhjfqdz .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#sbhqhjfqdz .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#sbhqhjfqdz .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#sbhqhjfqdz .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#sbhqhjfqdz .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#sbhqhjfqdz .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#sbhqhjfqdz .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#sbhqhjfqdz .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#sbhqhjfqdz .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#sbhqhjfqdz .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#sbhqhjfqdz .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#sbhqhjfqdz .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#sbhqhjfqdz .gt_left {
  text-align: left;
}

#sbhqhjfqdz .gt_center {
  text-align: center;
}

#sbhqhjfqdz .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#sbhqhjfqdz .gt_font_normal {
  font-weight: normal;
}

#sbhqhjfqdz .gt_font_bold {
  font-weight: bold;
}

#sbhqhjfqdz .gt_font_italic {
  font-style: italic;
}

#sbhqhjfqdz .gt_super {
  font-size: 65%;
}

#sbhqhjfqdz .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="sbhqhjfqdz" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">times_occured</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_center">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_center">2</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>This approach is unique but intuitive. By taking all possible ‘same’ combinations, we’ve effectively grouped any sort of duplicate <code>invoice_id</code> we may have already had. We then ungroup and resummarize without the <code>invoice_id</code>, which tells us how many times the <code>invoice_id</code> is different within the new group.</p>
<p>Lets save this information into our invoice table again:</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="test.html#cb334-1"></a>dupes_set2 &lt;-<span class="st"> </span>dupes_set2 <span class="op">%&gt;%</span></span>
<span id="cb334-2"><a href="test.html#cb334-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_dupes2 =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb334-3"><a href="test.html#cb334-3"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>times_occured)</span>
<span id="cb334-4"><a href="test.html#cb334-4"></a></span>
<span id="cb334-5"><a href="test.html#cb334-5"></a>invoices &lt;-<span class="st"> </span>invoices <span class="op">%&gt;%</span></span>
<span id="cb334-6"><a href="test.html#cb334-6"></a><span class="st">  </span><span class="kw">left_join</span>(dupes_set2, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;date&#39;</span>, <span class="st">&#39;amount&#39;</span>))</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#epobednyix .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#epobednyix .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#epobednyix .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#epobednyix .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#epobednyix .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#epobednyix .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#epobednyix .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#epobednyix .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#epobednyix .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#epobednyix .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#epobednyix .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#epobednyix .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#epobednyix .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#epobednyix .gt_from_md > :first-child {
  margin-top: 0;
}

#epobednyix .gt_from_md > :last-child {
  margin-bottom: 0;
}

#epobednyix .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#epobednyix .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#epobednyix .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#epobednyix .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#epobednyix .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#epobednyix .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#epobednyix .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#epobednyix .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#epobednyix .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#epobednyix .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#epobednyix .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#epobednyix .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#epobednyix .gt_left {
  text-align: left;
}

#epobednyix .gt_center {
  text-align: center;
}

#epobednyix .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#epobednyix .gt_font_normal {
  font-weight: normal;
}

#epobednyix .gt_font_bold {
  font-weight: bold;
}

#epobednyix .gt_font_italic {
  font-style: italic;
}

#epobednyix .gt_super {
  font-size: 65%;
}

#epobednyix .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="epobednyix" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">system_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">acctcode</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes1</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes2</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_left">157A</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_left">157B</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_left">158</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">6</td>
      <td class="gt_row gt_left">159</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">7</td>
      <td class="gt_row gt_left">160</td>
      <td class="gt_row gt_left">2019-01-04</td>
      <td class="gt_row gt_right">4000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>The beauty of this method is that, after you’ve run all the scenarios you prefer, you can rapidly assess each invoice and see what duplicate criteria they match. Ideally, you would balance having tests that are very general (same date, same amount) with tests of high precision (same date, same amount, and different account codes).</p>
</div>
<div id="aggregating-results" class="section level4">
<h4><span class="header-section-number">9.4.3.3</span> Aggregating results</h4>
<p>To derive the final list, becai effective to filter the results based on the <code>dupes</code> columns.</p>
<p>Starting with the invoices we’ve identified, we’ll first group by unique <code>system_id</code> we’ve created, allowing us to perform calculations on unique rows. To determine if any test did return something, we will take a <code>sum</code> of any number of columns that return a TRUE (with a value of 1 when coerced from logical to numeric). Then, we want to calculate this on multiple columns, specifically with the name starting with <code>dupes</code>, so we will use <code>across()</code> with <code>starts_with()</code>.</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb335-1"><a href="test.html#cb335-1"></a>invoices <span class="op">%&gt;%</span></span>
<span id="cb335-2"><a href="test.html#cb335-2"></a><span class="st">  </span><span class="kw">rowwise</span>(system_id) <span class="op">%&gt;%</span></span>
<span id="cb335-3"><a href="test.html#cb335-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">dupes =</span> <span class="kw">sum</span>(<span class="kw">across</span>(<span class="kw">starts_with</span>(<span class="st">&#39;t_dupes&#39;</span>)) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></span>
<span id="cb335-4"><a href="test.html#cb335-4"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb335-5"><a href="test.html#cb335-5"></a><span class="st">  </span><span class="kw">filter</span>(dupes <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb335-6"><a href="test.html#cb335-6"></a><span class="st">  </span><span class="kw">gt</span>()</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#ialppyiiew .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ialppyiiew .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ialppyiiew .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ialppyiiew .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ialppyiiew .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ialppyiiew .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ialppyiiew .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ialppyiiew .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ialppyiiew .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ialppyiiew .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ialppyiiew .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ialppyiiew .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#ialppyiiew .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ialppyiiew .gt_from_md > :first-child {
  margin-top: 0;
}

#ialppyiiew .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ialppyiiew .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ialppyiiew .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#ialppyiiew .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ialppyiiew .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#ialppyiiew .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ialppyiiew .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ialppyiiew .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ialppyiiew .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ialppyiiew .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ialppyiiew .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#ialppyiiew .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ialppyiiew .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#ialppyiiew .gt_left {
  text-align: left;
}

#ialppyiiew .gt_center {
  text-align: center;
}

#ialppyiiew .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ialppyiiew .gt_font_normal {
  font-weight: normal;
}

#ialppyiiew .gt_font_bold {
  font-weight: bold;
}

#ialppyiiew .gt_font_italic {
  font-style: italic;
}

#ialppyiiew .gt_super {
  font-size: 65%;
}

#ialppyiiew .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="ialppyiiew" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">system_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">acctcode</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes1</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes2</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">dupes</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_left">157A</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_left">157B</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_left">158</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">6</td>
      <td class="gt_row gt_left">159</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">1</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>This approach is powerful, yet flexible. By maintaining our approach of having a main <code>invoice</code> dataset with all the matches, any new tests we add starting with the column name <code>dupes</code> will be included. For example, if we inserted a higher precision test of same invoice date, amount, and account code, we’ll see our counts go up:</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="test.html#cb336-1"></a>dupes_set3 &lt;-<span class="st"> </span>invoices <span class="op">%&gt;%</span></span>
<span id="cb336-2"><a href="test.html#cb336-2"></a><span class="st">  </span><span class="kw">group_by</span>(date, amount, acctcode) <span class="op">%&gt;%</span></span>
<span id="cb336-3"><a href="test.html#cb336-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">times_occured =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb336-4"><a href="test.html#cb336-4"></a><span class="st">  </span><span class="kw">filter</span>(times_occured <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb336-5"><a href="test.html#cb336-5"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Remove the grouping aspect, which affects the ranking by row_number()</span></span>
<span id="cb336-6"><a href="test.html#cb336-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_dupes3 =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb336-7"><a href="test.html#cb336-7"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>times_occured)</span>
<span id="cb336-8"><a href="test.html#cb336-8"></a></span>
<span id="cb336-9"><a href="test.html#cb336-9"></a>invoices &lt;-<span class="st"> </span>invoices <span class="op">%&gt;%</span></span>
<span id="cb336-10"><a href="test.html#cb336-10"></a><span class="st">  </span><span class="kw">left_join</span>(dupes_set3, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;date&#39;</span>, <span class="st">&#39;amount&#39;</span>, <span class="st">&#39;acctcode&#39;</span>)) </span>
<span id="cb336-11"><a href="test.html#cb336-11"></a></span>
<span id="cb336-12"><a href="test.html#cb336-12"></a>invoices <span class="op">%&gt;%</span></span>
<span id="cb336-13"><a href="test.html#cb336-13"></a><span class="st">  </span><span class="kw">rowwise</span>(system_id) <span class="op">%&gt;%</span></span>
<span id="cb336-14"><a href="test.html#cb336-14"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_dupesmatched =</span> <span class="kw">sum</span>(<span class="kw">across</span>(<span class="kw">starts_with</span>(<span class="st">&#39;t_dupes&#39;</span>)) <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></span>
<span id="cb336-15"><a href="test.html#cb336-15"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb336-16"><a href="test.html#cb336-16"></a><span class="st">  </span><span class="kw">filter</span>(t_dupesmatched <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb336-17"><a href="test.html#cb336-17"></a><span class="st">  </span><span class="kw">gt</span>()</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#inlhtkzahi .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#inlhtkzahi .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#inlhtkzahi .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#inlhtkzahi .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#inlhtkzahi .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#inlhtkzahi .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#inlhtkzahi .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#inlhtkzahi .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#inlhtkzahi .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#inlhtkzahi .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#inlhtkzahi .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#inlhtkzahi .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#inlhtkzahi .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#inlhtkzahi .gt_from_md > :first-child {
  margin-top: 0;
}

#inlhtkzahi .gt_from_md > :last-child {
  margin-bottom: 0;
}

#inlhtkzahi .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#inlhtkzahi .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#inlhtkzahi .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#inlhtkzahi .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#inlhtkzahi .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#inlhtkzahi .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#inlhtkzahi .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#inlhtkzahi .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#inlhtkzahi .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#inlhtkzahi .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#inlhtkzahi .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#inlhtkzahi .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#inlhtkzahi .gt_left {
  text-align: left;
}

#inlhtkzahi .gt_center {
  text-align: center;
}

#inlhtkzahi .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#inlhtkzahi .gt_font_normal {
  font-weight: normal;
}

#inlhtkzahi .gt_font_bold {
  font-weight: bold;
}

#inlhtkzahi .gt_font_italic {
  font-style: italic;
}

#inlhtkzahi .gt_super {
  font-size: 65%;
}

#inlhtkzahi .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="inlhtkzahi" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">system_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">acctcode</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes1</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes2</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes3</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupesmatched</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_left">157A</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_left">157B</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_left">158</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">6</td>
      <td class="gt_row gt_left">159</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
    </tr>
  </tbody>
  
  
</table></div>
</div>
<div id="ruling-out-false-positives" class="section level4">
<h4><span class="header-section-number">9.4.3.4</span> Ruling out false positives</h4>
<p>Up to now, you’ve identified duplicates via the Same-Same-Same and Same-Same-Different methods. Perhaps in your own work, you’ve gone ahead and tested potential duplicates, and then realized there is some business logic you didn’t capture that may have nullified the potential duplicate, saving you time and effort.</p>
<p>A common reason for a false positive is that the company may have already received a refund for the invoice. In this case, its more practical to identify and remove invoices that have had refunds in the original invoice population prior to processing, using an <code>anti_join()</code>. For example, if invoice 156 with a system_id of <code>2</code> was already removed, you could refine the invoice population before executing additional tests.</p>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb337-1"><a href="test.html#cb337-1"></a>refunds &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">system_id =</span> <span class="dv">2</span>) <span class="co"># A table of credits or refunds</span></span>
<span id="cb337-2"><a href="test.html#cb337-2"></a></span>
<span id="cb337-3"><a href="test.html#cb337-3"></a>new_invoices &lt;-<span class="st"> </span>invoices <span class="op">%&gt;%</span></span>
<span id="cb337-4"><a href="test.html#cb337-4"></a><span class="st">  </span><span class="kw">anti_join</span>(refunds, <span class="dt">by =</span> <span class="st">&#39;system_id&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Remove refunds</span></span>
<span id="cb337-5"><a href="test.html#cb337-5"></a><span class="st">  </span><span class="kw">select</span>(system_id, invoice_id, date, amount, acctcode)</span>
<span id="cb337-6"><a href="test.html#cb337-6"></a></span>
<span id="cb337-7"><a href="test.html#cb337-7"></a>new_invoices <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb337-8"><a href="test.html#cb337-8"></a><span class="st">  </span><span class="kw">gt</span>()</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#bvqqiydsfb .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#bvqqiydsfb .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bvqqiydsfb .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#bvqqiydsfb .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#bvqqiydsfb .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bvqqiydsfb .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bvqqiydsfb .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#bvqqiydsfb .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#bvqqiydsfb .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#bvqqiydsfb .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#bvqqiydsfb .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#bvqqiydsfb .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#bvqqiydsfb .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#bvqqiydsfb .gt_from_md > :first-child {
  margin-top: 0;
}

#bvqqiydsfb .gt_from_md > :last-child {
  margin-bottom: 0;
}

#bvqqiydsfb .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#bvqqiydsfb .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#bvqqiydsfb .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bvqqiydsfb .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#bvqqiydsfb .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bvqqiydsfb .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#bvqqiydsfb .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#bvqqiydsfb .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bvqqiydsfb .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bvqqiydsfb .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#bvqqiydsfb .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bvqqiydsfb .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#bvqqiydsfb .gt_left {
  text-align: left;
}

#bvqqiydsfb .gt_center {
  text-align: center;
}

#bvqqiydsfb .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#bvqqiydsfb .gt_font_normal {
  font-weight: normal;
}

#bvqqiydsfb .gt_font_bold {
  font-weight: bold;
}

#bvqqiydsfb .gt_font_italic {
  font-style: italic;
}

#bvqqiydsfb .gt_super {
  font-size: 65%;
}

#bvqqiydsfb .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="bvqqiydsfb" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">system_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">acctcode</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_left">157A</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_left">157B</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_left">158</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6100</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">6</td>
      <td class="gt_row gt_left">159</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6200</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">7</td>
      <td class="gt_row gt_left">160</td>
      <td class="gt_row gt_left">2019-01-04</td>
      <td class="gt_row gt_right">4000</td>
      <td class="gt_row gt_right">6100</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>A duplicate may also be ruled out because because of a minor field that wasn’t used. If you examine lines 5 and 6, you’ll see that that this invoice was picked up because of the same <code>date</code> &amp; <code>amount</code>, with a different <code>invoice_id</code>. You may have noticed that the <code>acctcode</code> is different, representing that the invoice was being allocated to a different cost center. After inquiring with the business, you may determine this behavior is normal. Its easier add another test to accommodate for this scenario, following the Same-Same-Different approach, to help increase the accuracy of test:</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="test.html#cb338-1"></a>dupes_set4 &lt;-<span class="st"> </span>invoices <span class="op">%&gt;%</span></span>
<span id="cb338-2"><a href="test.html#cb338-2"></a><span class="st">  </span><span class="kw">group_by</span>(invoice_id, date, amount, acctcode) <span class="op">%&gt;%</span></span>
<span id="cb338-3"><a href="test.html#cb338-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">times_occured =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb338-4"><a href="test.html#cb338-4"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Remove the grouping aspect, which is kept by default in dplyr</span></span>
<span id="cb338-5"><a href="test.html#cb338-5"></a><span class="st">  </span><span class="kw">group_by</span>(date, amount, acctcode) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Second set of reductions, but this time, find how many unique invoice ids there are per date-amount</span></span>
<span id="cb338-6"><a href="test.html#cb338-6"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">times_occured =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb338-7"><a href="test.html#cb338-7"></a><span class="st">  </span><span class="kw">filter</span>(times_occured <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb338-8"><a href="test.html#cb338-8"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Remove the grouping aspect, which affects the ranking by row_number()</span></span>
<span id="cb338-9"><a href="test.html#cb338-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_dupes4 =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb338-10"><a href="test.html#cb338-10"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>times_occured)</span>
<span id="cb338-11"><a href="test.html#cb338-11"></a></span>
<span id="cb338-12"><a href="test.html#cb338-12"></a>invoices &lt;-<span class="st"> </span>invoices <span class="op">%&gt;%</span></span>
<span id="cb338-13"><a href="test.html#cb338-13"></a><span class="st">  </span><span class="kw">left_join</span>(dupes_set4, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;date&#39;</span>, <span class="st">&#39;amount&#39;</span>, <span class="st">&#39;acctcode&#39;</span>))</span>
<span id="cb338-14"><a href="test.html#cb338-14"></a></span>
<span id="cb338-15"><a href="test.html#cb338-15"></a>invoices <span class="op">%&gt;%</span></span>
<span id="cb338-16"><a href="test.html#cb338-16"></a><span class="st">  </span><span class="kw">gt</span>()</span></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#dvqreqhczr .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#dvqreqhczr .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dvqreqhczr .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#dvqreqhczr .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#dvqreqhczr .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dvqreqhczr .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dvqreqhczr .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#dvqreqhczr .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#dvqreqhczr .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#dvqreqhczr .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#dvqreqhczr .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#dvqreqhczr .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#dvqreqhczr .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#dvqreqhczr .gt_from_md > :first-child {
  margin-top: 0;
}

#dvqreqhczr .gt_from_md > :last-child {
  margin-bottom: 0;
}

#dvqreqhczr .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#dvqreqhczr .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#dvqreqhczr .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dvqreqhczr .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#dvqreqhczr .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dvqreqhczr .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#dvqreqhczr .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#dvqreqhczr .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dvqreqhczr .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dvqreqhczr .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#dvqreqhczr .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dvqreqhczr .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#dvqreqhczr .gt_left {
  text-align: left;
}

#dvqreqhczr .gt_center {
  text-align: center;
}

#dvqreqhczr .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#dvqreqhczr .gt_font_normal {
  font-weight: normal;
}

#dvqreqhczr .gt_font_bold {
  font-weight: bold;
}

#dvqreqhczr .gt_font_italic {
  font-style: italic;
}

#dvqreqhczr .gt_super {
  font-size: 65%;
}

#dvqreqhczr .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="dvqreqhczr" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">system_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">invoice_id</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">amount</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">acctcode</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes1</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes2</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes3</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">t_dupes4</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_left">156</td>
      <td class="gt_row gt_left">2019-01-01</td>
      <td class="gt_row gt_right">1000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_left">157A</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_left">157B</td>
      <td class="gt_row gt_left">2019-01-02</td>
      <td class="gt_row gt_right">2500</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_left">158</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">6</td>
      <td class="gt_row gt_left">159</td>
      <td class="gt_row gt_left">2019-01-03</td>
      <td class="gt_row gt_right">3000</td>
      <td class="gt_row gt_right">6200</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">7</td>
      <td class="gt_row gt_left">160</td>
      <td class="gt_row gt_left">2019-01-04</td>
      <td class="gt_row gt_right">4000</td>
      <td class="gt_row gt_right">6100</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">NA</td>
      <td class="gt_row gt_center">NA</td>
    </tr>
  </tbody>
  
  
</table></div>
</div>
</div>
<div id="detecting-gaps-in-sequences" class="section level3">
<h3><span class="header-section-number">9.4.4</span> Detecting gaps in sequences</h3>
<p>A sequential test is commonly used for cheques, specifically to determine which ones are missing from a cheque run. They are also useful for measuring a level of dependency that a vendor relies upon a company, assuming the vendor issue invoices sequentially as well.</p>
<p>As an example, lets say we create a register with 1000 cheques. You can start with any minimum and maximum range:</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="test.html#cb339-1"></a>register &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">1020</span>, <span class="dv">2019</span>)</span>
<span id="cb339-2"><a href="test.html#cb339-2"></a><span class="kw">length</span>(register)</span></code></pre></div>
<pre><code>## [1] 1000</code></pre>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="test.html#cb341-1"></a><span class="kw">range</span>(register)</span></code></pre></div>
<pre><code>## [1] 1020 2019</code></pre>
<p>And if we were to create a listing of all cheques we have written, we could simulate perhaps 50 cheques that were taken out:</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="test.html#cb343-1"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb343-2"><a href="test.html#cb343-2"></a>cheques_issued &lt;-<span class="st"> </span><span class="kw">sample</span>(register, <span class="dt">size =</span> <span class="dv">975</span>)</span></code></pre></div>
<p>To detect which cheques have been taken out, we can check the difference between our sets using <code>setdiff()</code> - that is, if we compare our original cheque register to the cheques issued, we can see which ones were missing:</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="test.html#cb344-1"></a>missing &lt;-<span class="st"> </span><span class="kw">setdiff</span>(register, cheques_issued)</span>
<span id="cb344-2"><a href="test.html#cb344-2"></a></span>
<span id="cb344-3"><a href="test.html#cb344-3"></a>missing</span></code></pre></div>
<pre><code>##  [1] 1026 1062 1079 1166 1201 1302 1375 1378 1385 1387 1455 1493 1503 1504 1510
##  [ reached getOption(&quot;max.print&quot;) -- omitted 10 entries ]</code></pre>
<p>If you wanted to know which ones were sequential, you could check the differences between each missing cheque. In this case, it would be a <code>lag()</code> calculation first, to find the difference between each row:</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="test.html#cb346-1"></a><span class="kw">data.frame</span>(missing) <span class="op">%&gt;%</span></span>
<span id="cb346-2"><a href="test.html#cb346-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gap_between =</span> missing <span class="op">-</span><span class="st"> </span><span class="kw">lag</span>(missing))</span></code></pre></div>
<pre><code>##   missing gap_between
## 1    1026          NA
## 2    1062          36
## 3    1079          17
## 4    1166          87
## 5    1201          35
## 6    1302         101
## 7    1375          73
##  [ reached &#39;max&#39; / getOption(&quot;max.print&quot;) -- omitted 18 rows ]</code></pre>
<p>And finally, since we want to know which sequential cheques were missing, we could filter and look for any rows that had only a difference of one, implying one missing cheque. Since we want chains, we also want to look ahead with <code>lead()</code> since</p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="test.html#cb348-1"></a><span class="kw">data.frame</span>(missing) <span class="op">%&gt;%</span></span>
<span id="cb348-2"><a href="test.html#cb348-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gap_between =</span> missing <span class="op">-</span><span class="st"> </span><span class="kw">lag</span>(missing)) <span class="op">%&gt;%</span></span>
<span id="cb348-3"><a href="test.html#cb348-3"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">lead</span>(gap_between) <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span><span class="co"># Chooses the first row in the chain, by looking at the next row to see if its equal to one</span></span>
<span id="cb348-4"><a href="test.html#cb348-4"></a><span class="st">         </span>gap_between <span class="op">==</span><span class="dv">1</span> ) <span class="co"># Any subsequent numbers will always have a difference of 1</span></span></code></pre></div>
<pre><code>##   missing gap_between
## 1    1503          10
## 2    1504           1
## 3    1661          86
## 4    1662           1</code></pre>
</div>
</div>
<div id="test-searchtext" class="section level2">
<h2><span class="header-section-number">9.5</span> Search text</h2>
<p>For typical fields in a structured dataset, it is straight forward to <code>filter()</code> on a field to isolate specific traits, like usernames or accounts. However, a great deal of information kept within a database is also unstructured, where the user is allowed to input their own information as they see fit, like description or comment fields. While this information is messy, free-form and generally user-generated, it usually contains a valuable trove of information</p>
<p>To scan these unstructured datasets, you need an effective, powerful and rapid method for analysis. Key word searches are an effective method of isolating high-value entries, especially when examining invoices, journal entries, or other datasets where the data may be inconsistent. We may also be interested in words that imply an action like override, or simply looking for mentions of a name in a comment field.</p>
<div id="regex-basics" class="section level3">
<h3><span class="header-section-number">9.5.1</span> Regex basics</h3>
<p>We will need to expand our skill set and dabble in regular expression, also known as <strong>regex</strong>. Regular expression is another language that specializes in the searching of patterns, specifically within text fields.</p>
<p>To use regex effectively, you need to consider the pattern of the text to look for, and the field you want to search up. Lets start off by listing of Canadian capitial cities and their provinces:</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb350-1"><a href="test.html#cb350-1"></a>canada &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">province =</span> <span class="kw">c</span>(<span class="st">&quot;Newfoundland and Labrador&quot;</span>, <span class="st">&quot;Prince Edward Island&quot;</span>, <span class="st">&quot;Nova Scotia&quot;</span>, <span class="st">&quot;New Brunswick&quot;</span>, <span class="st">&quot;Quebec&quot;</span>, <span class="st">&quot;Ontario&quot;</span>, <span class="st">&quot;Manitoba&quot;</span>, <span class="st">&quot;Saskatchewan&quot;</span>, <span class="st">&quot;Alberta&quot;</span>, <span class="st">&quot;British Columbia&quot;</span>, <span class="st">&quot;Nunavut&quot;</span>, <span class="st">&quot;Northwest Territories&quot;</span>, <span class="st">&quot;Yukon Territory&quot;</span>),</span>
<span id="cb350-2"><a href="test.html#cb350-2"></a>                     <span class="dt">capital =</span> <span class="kw">c</span>(<span class="st">&quot;St. John&#39;s&quot;</span>, <span class="st">&quot;Charlottetown&quot;</span>, <span class="st">&quot;Halifax&quot;</span>, <span class="st">&quot;Fredericton&quot;</span>, <span class="st">&quot;Québec City&quot;</span>, <span class="st">&quot;Toronto&quot;</span>, <span class="st">&quot;Winnipeg&quot;</span>, <span class="st">&quot;Regina&quot;</span>, <span class="st">&quot;Edmonton&quot;</span>, <span class="st">&quot;Victoria&quot;</span>, <span class="st">&quot;Iqaluit&quot;</span>, <span class="st">&quot;Yellowknife&quot;</span>, <span class="st">&quot;Whitehorse&quot;</span>))</span>
<span id="cb350-3"><a href="test.html#cb350-3"></a></span>
<span id="cb350-4"><a href="test.html#cb350-4"></a><span class="kw">print</span>(canada)</span></code></pre></div>
<pre><code>##                    province       capital
## 1 Newfoundland and Labrador    St. John&#39;s
## 2      Prince Edward Island Charlottetown
## 3               Nova Scotia       Halifax
## 4             New Brunswick   Fredericton
## 5                    Quebec   Québec City
## 6                   Ontario       Toronto
## 7                  Manitoba      Winnipeg
##  [ reached &#39;max&#39; / getOption(&quot;max.print&quot;) -- omitted 6 rows ]</code></pre>
<p>Lets say we wanted to find the city of Edmonton in the column of capitals. We’ll use R base function <code>grepl()</code>, which needs a string to search up and a pattern to look into. It returns a logical vector, telling us where matches occur.</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="test.html#cb352-1"></a><span class="kw">grepl</span>(<span class="st">&#39;Edmonton&#39;</span>, canada<span class="op">$</span>capital)</span></code></pre></div>
<pre><code>##  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE
## [13] FALSE</code></pre>
<p>There is only one row that matches our test. We can use this to further isolate our data:</p>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb354-1"><a href="test.html#cb354-1"></a>canada <span class="op">%&gt;%</span></span>
<span id="cb354-2"><a href="test.html#cb354-2"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&#39;Edmonton&#39;</span>, capital))</span></code></pre></div>
<pre><code>##   province  capital
## 1  Alberta Edmonton</code></pre>
<p>What if you wanted to find two words? Separate words with the <code>|</code> (pipe) character, which stands for ‘or’, and you chain as many words as you like:</p>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb356-1"><a href="test.html#cb356-1"></a>canada <span class="op">%&gt;%</span></span>
<span id="cb356-2"><a href="test.html#cb356-2"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&#39;Charlottetown|Regina&#39;</span>, capital))</span></code></pre></div>
<pre><code>##               province       capital
## 1 Prince Edward Island Charlottetown
## 2         Saskatchewan        Regina</code></pre>
<p>Regular expressions are powerful because you can customize them to the nth degree. I’ll highlight a few of the common use cases in testing.</p>
</div>
<div id="starts-or-ends-with-anchors" class="section level3">
<h3><span class="header-section-number">9.5.2</span> Starts or Ends with (Anchors)</h3>
<p>Lets say you wanted to find any provinces starting with ‘o’. Lets start with this:</p>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb358-1"><a href="test.html#cb358-1"></a>canada <span class="op">%&gt;%</span></span>
<span id="cb358-2"><a href="test.html#cb358-2"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&#39;o&#39;</span>, province))</span></code></pre></div>
<pre><code>##                    province     capital
## 1 Newfoundland and Labrador  St. John&#39;s
## 2               Nova Scotia     Halifax
## 3                   Ontario     Toronto
## 4                  Manitoba    Winnipeg
## 5          British Columbia    Victoria
## 6     Northwest Territories Yellowknife
## 7           Yukon Territory  Whitehorse</code></pre>
<p>Notice that <code>grepl()</code> is returning any rows where where ‘o’ is found in the province. We can be more precise and use the prefix <code>^</code>, which is an anchor. This directs regex to only match where it finds a match at the beginning of the string.</p>
<p>As regex is case sensitive, we can tell regex to ignore case sensitivity by using the <code>ignore.case = TRUE</code> argument, which allows us to include both upper and lower case letters in our search (you can try <code>grepl('^o', province)</code> and see what happens):</p>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="test.html#cb360-1"></a>canada <span class="op">%&gt;%</span></span>
<span id="cb360-2"><a href="test.html#cb360-2"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&#39;^o&#39;</span>, province, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>##   province capital
## 1  Ontario Toronto</code></pre>
<p>What if we wanted to find all capitals ending in ‘ton’? There is another anchor we can use, <code>$</code>, which tells us that we should match the regex only at the end of a string:</p>
<div class="sourceCode" id="cb362"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb362-1"><a href="test.html#cb362-1"></a>canada <span class="op">%&gt;%</span></span>
<span id="cb362-2"><a href="test.html#cb362-2"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&#39;ton$&#39;</span>, capital, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>##        province     capital
## 1 New Brunswick Fredericton
## 2       Alberta    Edmonton</code></pre>
</div>
<div id="crash-course-in-encoding" class="section level3">
<h3><span class="header-section-number">9.5.3</span> Crash course in Encoding</h3>
<p>Simple question. What if we wanted to find Quebec City?</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="test.html#cb364-1"></a>canada <span class="op">%&gt;%</span></span>
<span id="cb364-2"><a href="test.html#cb364-2"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&#39;Quebec&#39;</span>, capital))</span></code></pre></div>
<pre><code>## [1] province capital 
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
<p>There are no hits! But why is that? If you look closely at Quebec, you’ll notice the accented é in Quêbec City. Unfortunately, regex is quite strict on character matching, and you will need to prepare on how to deal with these situations. (Did you notice that the accented é is in Québec City but not the province of Quebec? Why? The province is the English constitutional name and therefore has no diacritics.<span class="citation">(“Wikipedia, Name of Quebec City” <a href="#ref-quebec" role="doc-biblioref">2020</a>)</span>)</p>
<p>Text can be ‘encoded’ in multiple ways. Encoding is the way a computer saves the representation of a letter. If you look at your standard QWERTY keyboard (which is probably in front of you), you’ll see letters and numbers. Each letter on your keyboard can be represented by a sequence of 8 bits (aka a byte), or a combination of zeros and ones. For example, the letter <code>A</code> can be represented as:</p>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="test.html#cb366-1"></a>pryr<span class="op">::</span><span class="kw">bits</span>(<span class="st">&#39;A&#39;</span>) </span></code></pre></div>
<pre><code>## [1] &quot;01000001&quot;</code></pre>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb368-1"><a href="test.html#cb368-1"></a><span class="kw">Encoding</span>(<span class="st">&#39;A&#39;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;unknown&quot;</code></pre>
<p><strong>pryr</strong> is good for understanding the depths of R. In this case, its helpful for us in understanding character encodings. In this case, the letter is represented as one single byte block with eight bits, which is typical of the <strong>ASCII encoding</strong>. In R, ASCII is also known as ‘unknown’ - not because it is truly unknown, but because ASCII is the same across all computer systems, no matter if you’re using Unix, Windows, or Mac.</p>
<p>What if we did the accented é in Québec City?</p>
<div class="sourceCode" id="cb370"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb370-1"><a href="test.html#cb370-1"></a>pryr<span class="op">::</span><span class="kw">bits</span>(<span class="st">&#39;é&#39;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;11000011 10101001&quot;</code></pre>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="test.html#cb372-1"></a><span class="kw">Encoding</span>(<span class="st">&#39;é&#39;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;UTF-8&quot;</code></pre>
<p>Notice there are two bytes! This is known as a <strong>multi-byte encoding</strong>, and here it is represented as <strong>UTF-8</strong> (or Unicode 8-bit). In multi-byte encodings, multiple bytes (could be more than two!) could be used to represent a single character on a screen.</p>
</div>
<div id="cleaning-text" class="section level3">
<h3><span class="header-section-number">9.5.4</span> Cleaning Text</h3>
<p>One method of cleaning text information, especially if perfect replication isn’t necessary, is to strip out any and all characters with accents/diacritics. <a href="https://stackoverflow.com/questions/26393341/r-delete-accents-in-string">This method</a> appears to be the most effective, and uses the <strong>stringi</strong> library and the <code>stri_trans_general()</code> function.</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb374-1"><a href="test.html#cb374-1"></a>clean_e &lt;-<span class="st"> </span>stringi<span class="op">::</span><span class="kw">stri_trans_general</span>(<span class="st">&#39;é&#39;</span>, <span class="st">&#39;Latin-ASCII&#39;</span>)</span>
<span id="cb374-2"><a href="test.html#cb374-2"></a>clean_e</span></code></pre></div>
<pre><code>## [1] &quot;e&quot;</code></pre>
<div class="sourceCode" id="cb376"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb376-1"><a href="test.html#cb376-1"></a><span class="kw">Encoding</span>(clean_e)</span></code></pre></div>
<pre><code>## [1] &quot;unknown&quot;</code></pre>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb378-1"><a href="test.html#cb378-1"></a>pryr<span class="op">::</span><span class="kw">bits</span>(clean_e)</span></code></pre></div>
<pre><code>## [1] &quot;01100101&quot;</code></pre>
<p>So if we apply this cleaning conversion across the cities in our dataset, we can then find words without worrying about accents.</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb380-1"><a href="test.html#cb380-1"></a>canada <span class="op">%&gt;%</span></span>
<span id="cb380-2"><a href="test.html#cb380-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">capital =</span> stringi<span class="op">::</span><span class="kw">stri_trans_general</span>(capital, <span class="st">&#39;Latin-ASCII&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb380-3"><a href="test.html#cb380-3"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&#39;Quebec&#39;</span>, capital, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>##   province     capital
## 1   Quebec Quebec City</code></pre>
</div>
<div id="searching-multiple-fields" class="section level3">
<h3><span class="header-section-number">9.5.5</span> Searching Multiple Fields</h3>
<p>Using <code>grepl()</code>, we can detect text phrases in one column. More often than not, we are searching not only for multiple words, but across any text columns as well.</p>
<p>First off, lets assemble a set of test words to search in our GL dataset, separating them with the ‘or’ symbol:</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb382-1"><a href="test.html#cb382-1"></a>searchterms &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;quebec&#39;</span>, <span class="st">&#39;facilitation&#39;</span>, <span class="st">&#39;as per&#39;</span>)</span>
<span id="cb382-2"><a href="test.html#cb382-2"></a>searchterms &lt;-<span class="st"> </span><span class="kw">paste</span>(searchterms, <span class="dt">collapse =</span> <span class="st">&quot;|&quot;</span>)</span></code></pre></div>
<p>We’re going to use dplyr syntax to <a href="https://dplyr.tidyverse.org/articles/colwise.html#how-do-you-convert-existing-code-">search multiple columns</a>, and explain how its working. To search across text, we need to create a little helper function first. Lets make a function that will tell us if any row has more than 0, which is another way of saying lets evaluate this row as <code>TRUE</code> if any number of columns found is <code>TRUE.</code></p>
<div class="sourceCode" id="cb383"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb383-1"><a href="test.html#cb383-1"></a>rowAny &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">rowSums</span>(x) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span></span></code></pre></div>
<p>Lets say you had three columns, and you were looking for a word in each one. After executing <code>grepl()</code> on each one, you got this result, indicating <code>TRUE</code> where the word was found.</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb384-1"><a href="test.html#cb384-1"></a>example &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">colA =</span> <span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">FALSE</span>),</span>
<span id="cb384-2"><a href="test.html#cb384-2"></a>          <span class="dt">colB =</span> <span class="kw">c</span>(<span class="ot">FALSE</span>, <span class="ot">FALSE</span>, <span class="ot">FALSE</span>),</span>
<span id="cb384-3"><a href="test.html#cb384-3"></a>          <span class="dt">colC =</span> <span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">TRUE</span>))</span>
<span id="cb384-4"><a href="test.html#cb384-4"></a></span>
<span id="cb384-5"><a href="test.html#cb384-5"></a>example</span></code></pre></div>
<pre><code>##    colA  colB  colC
## 1  TRUE FALSE  TRUE
## 2 FALSE FALSE FALSE
## 3 FALSE FALSE  TRUE</code></pre>
<p>Then <code>rowAny()</code> would evaluate as:</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb386-1"><a href="test.html#cb386-1"></a>example<span class="op">$</span>rowAnyResult &lt;-<span class="st"> </span><span class="kw">rowAny</span>(example)</span>
<span id="cb386-2"><a href="test.html#cb386-2"></a></span>
<span id="cb386-3"><a href="test.html#cb386-3"></a>example</span></code></pre></div>
<pre><code>##    colA  colB  colC rowAnyResult
## 1  TRUE FALSE  TRUE         TRUE
## 2 FALSE FALSE FALSE        FALSE
## 3 FALSE FALSE  TRUE         TRUE</code></pre>
<p>This outcome will then be used as the filter to return the matching rows.</p>
<p><code>across()</code> is a relatively young function that came with dplyr 1.0.0. It basically allows you to run a function ‘across’ multiple columns. <code>across()</code> has two arguments:</p>
<ul>
<li>the first argument, <code>.cols</code>, is where you want your function to apply to. You could say <code>everything()</code> for all columns, or only run the function on where the column name <code>contains()</code> a certain word, or <code>where(is.numeric))</code> specifically for numeric columns.</li>
<li>the second argument, <code>.fns</code>, is where you specify the function itself. Here, we specify <code>grepl</code>, but make one change: instead of listing a specific column, we instead use <code>.x</code> to indicate which column we want to analyze.</li>
</ul>
<p>In our case, we want to run the function <code>grepl</code> (with arguments) ‘across’ <code>everything()</code></p>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb388-1"><a href="test.html#cb388-1"></a>gl <span class="op">%&gt;%</span></span>
<span id="cb388-2"><a href="test.html#cb388-2"></a><span class="st"> </span><span class="kw">filter</span>(<span class="kw">rowAny</span>(</span>
<span id="cb388-3"><a href="test.html#cb388-3"></a>   <span class="kw">across</span>(<span class="kw">everything</span>(), <span class="op">~</span><span class="st"> </span><span class="kw">grepl</span>(searchterms, .x, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))</span>
<span id="cb388-4"><a href="test.html#cb388-4"></a>   ))</span></code></pre></div>
<pre><code>## # A tibble: 4 x 11
##   je_num amount gl_date    vendor_id account invoice_date description paid_date 
##    &lt;int&gt;  &lt;dbl&gt; &lt;date&gt;         &lt;int&gt; &lt;chr&gt;   &lt;date&gt;       &lt;chr&gt;       &lt;date&gt;    
## 1    743   166. 2019-04-02        77 exp_me… NA           Quebec Cit… NA        
## 2    743  -166. 2019-04-02        NA liab_c… NA           Quebec Cit… NA        
## 3    755  9715. 2019-03-25      2211 exp_co… 2019-03-10   Facilitati… 2019-03-25
## 4    755 -9715. 2019-03-25        NA liab_a… 2019-03-10   Facilitati… 2019-03-25
## # … with 3 more variables: day_of_week &lt;ord&gt;, t_weekend &lt;lgl&gt;,
## #   end_of_month &lt;date&gt;</code></pre>
<p>What if we wanted to make individual columns for each test, and sum them up like we do for our standard testing approach? That can be done as well. First, lets make new columns for each of our keywords (and make sure it works)</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb390-1"><a href="test.html#cb390-1"></a>keyword_matches &lt;-<span class="st"> </span>gl <span class="op">%&gt;%</span></span>
<span id="cb390-2"><a href="test.html#cb390-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_quebec =</span> <span class="kw">rowAny</span>(<span class="kw">across</span>(<span class="kw">everything</span>(), <span class="op">~</span><span class="st"> </span><span class="kw">grepl</span>(<span class="st">&#39;quebec&#39;</span>, .x, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))),</span>
<span id="cb390-3"><a href="test.html#cb390-3"></a>         <span class="dt">t_facilitation =</span> <span class="kw">rowAny</span>(<span class="kw">across</span>(<span class="kw">everything</span>(), <span class="op">~</span><span class="st"> </span><span class="kw">grepl</span>(<span class="st">&#39;facilitation&#39;</span>, .x, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))),</span>
<span id="cb390-4"><a href="test.html#cb390-4"></a>         <span class="dt">t_as_per =</span> <span class="kw">rowAny</span>(<span class="kw">across</span>(<span class="kw">everything</span>(), <span class="op">~</span><span class="st"> </span><span class="kw">grepl</span>(<span class="st">&#39;as per&#39;</span>, .x, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>)))) <span class="op">%&gt;%</span></span>
<span id="cb390-5"><a href="test.html#cb390-5"></a><span class="st">  </span><span class="kw">select</span>(je_num, t_quebec, t_facilitation, t_as_per) <span class="op">%&gt;%</span></span>
<span id="cb390-6"><a href="test.html#cb390-6"></a><span class="st">  </span><span class="kw">filter</span>(t_quebec <span class="op">|</span><span class="st"> </span>t_facilitation <span class="op">|</span><span class="st"> </span>t_as_per)</span>
<span id="cb390-7"><a href="test.html#cb390-7"></a></span>
<span id="cb390-8"><a href="test.html#cb390-8"></a>keyword_matches</span></code></pre></div>
<pre><code>## # A tibble: 4 x 4
##   je_num t_quebec t_facilitation t_as_per
##    &lt;int&gt; &lt;lgl&gt;    &lt;lgl&gt;          &lt;lgl&gt;   
## 1    743 TRUE     FALSE          FALSE   
## 2    743 TRUE     FALSE          FALSE   
## 3    755 FALSE    TRUE           TRUE    
## 4    755 FALSE    TRUE           TRUE</code></pre>
<p>We can also see how many keywords match each row:</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb392-1"><a href="test.html#cb392-1"></a>keyword_matches <span class="op">%&gt;%</span></span>
<span id="cb392-2"><a href="test.html#cb392-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_keywords =</span> <span class="kw">rowSums</span>(<span class="kw">across</span>(<span class="kw">starts_with</span>(<span class="st">&#39;t_&#39;</span>))))</span></code></pre></div>
<pre><code>## # A tibble: 4 x 5
##   je_num t_quebec t_facilitation t_as_per t_keywords
##    &lt;int&gt; &lt;lgl&gt;    &lt;lgl&gt;          &lt;lgl&gt;         &lt;dbl&gt;
## 1    743 TRUE     FALSE          FALSE             1
## 2    743 TRUE     FALSE          FALSE             1
## 3    755 FALSE    TRUE           TRUE              2
## 4    755 FALSE    TRUE           TRUE              2</code></pre>
</div>
<div id="regex-further" class="section level3">
<h3><span class="header-section-number">9.5.6</span> Further reading</h3>
<p>Regular expressions are powerful, yet deeply complicated. Many sources exist to explain regex (<a href="https://regexone.com">1</a>, <a href="https://www.regular-expressions.info/quickstart.html">2</a>, <a href="https://regexr.com">3</a>). Many R packages have functions to help you understand and make use of regex as well - check out the <strong>stringr</strong> and <strong>stringi</strong> packages for some of these, as well as the help file with <code>?grep</code>.</p>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-nigrini-forensicanalytics-ch11">
<p><em>Identifying Anomalies Using the Relative Size Factor Test</em>. 2012. John Wiley &amp; Sons, Ltd. <a href="https://doi.org/10.1002/9781118386798.ch11">https://doi.org/10.1002/9781118386798.ch11</a>.</p>
</div>
<div id="ref-nigrini-forensicanalytics-ch12">
<p><em>Identifying Fraud Using Abnormal Duplications Within Subsets</em>. 2012. John Wiley &amp; Sons, Ltd. <a href="https://doi.org/10.1002/9781118386798.ch12">https://doi.org/10.1002/9781118386798.ch12</a>.</p>
</div>
<div id="ref-outliers">
<p><em>NIST/Sematech E-Handbook of Statistical Methods</em>. n.d. <a href="https://www.itl.nist.gov/div898/handbook/prc/section1/prc16.htm">https://www.itl.nist.gov/div898/handbook/prc/section1/prc16.htm</a>.</p>
</div>
<div id="ref-quebec">
<p>“Wikipedia, Name of Quebec City.” 2020. <em>Wikipedia</em>. Wikimedia Foundation. <a href="https://en.wikipedia.org/wiki/Name_of_Quebec_City">https://en.wikipedia.org/wiki/Name_of_Quebec_City</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="exploring-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="report.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Audit_Analytics_with-R.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
